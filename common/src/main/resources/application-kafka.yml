# Kafka 공통 설정
# 모든 서비스에서 spring.config.import로 포함하여 사용
#
# 사용법:
# application.yml에 다음 추가:
# spring:
#   config:
#     import: classpath:application-kafka.yml

spring:
  kafka:
    bootstrap-servers: localhost:9093

    # ========================================
    # Observation (분산 추적 - Kafka 헤더에 W3C traceparent 전파)
    # ========================================
    # [2026-02-09] Claude Opus 4 (claude-opus-4-6) 추가
    #
    # Spring Kafka 3.x에서 observation-enabled는 기본값 false.
    # 이 설정을 true로 하면:
    #   - Producer: kafkaTemplate.send() 시 현재 micrometer scope의 traceId를
    #     W3C traceparent 헤더로 Kafka 메시지에 자동 주입
    #   - Consumer: Kafka 메시지 수신 시 traceparent 헤더에서 traceId를 추출하여
    #     micrometer scope에 parent로 설정 → 동일한 traceId로 span 생성
    #
    # 이 설정이 없으면 Kafka를 통한 서비스 간 trace 전파가 불가능하여
    # 각 서비스가 독립된 traceId를 생성함 (Grafana Tempo에서 서비스별 별도 trace로 표시)
    template:
      observation-enabled: true   # Producer 측: Kafka 헤더에 traceparent 주입
    listener:
      # ⚠️ 주의: KafkaConsumerConfig.kt에서 커스텀 ConcurrentKafkaListenerContainerFactory 빈을
      # 직접 정의하고 있으므로, 이 YAML의 listener 설정은 Spring Boot 자동설정 ContainerFactory에만 적용됨.
      # 실제 Consumer 측 observation 활성화는 KafkaConsumerConfig.kt에서 프로그래밍 방식으로 적용:
      #   factory.containerProperties.isObservationEnabled = true
      # 여기에도 명시하는 이유: 향후 커스텀 빈 제거 시 자동설정이 올바르게 동작하도록 선언적 보장
      observation-enabled: true   # Consumer 측: Kafka 헤더에서 traceparent 추출

    producer:
      # ========================================
      # 신뢰성 설정 (at-least-once 보장)
      # ========================================

      # 모든 replica에 쓰기 완료까지 대기 (가장 안전)
      acks: all

      # 거의 무한 재시도
      retries: 2147483647

      # 재시도 간격 (100ms)
      retry-backoff-ms: 100

      # 멱등성 프로듀서 (중복 제거)
      enable-idempotence: true

      # 순서 보장 (멱등성 활성화 시 최대 5)
      max-in-flight-requests-per-connection: 5

      # 타임아웃 설정
      request-timeout-ms: 30000
      delivery-timeout-ms: 120000

      # ========================================
      # 성능 설정
      # ========================================

      # 배치 크기 (성능 향상)
      batch-size: 16384

      # 배치 대기 시간
      linger-ms: 10

      # 압축
      compression-type: snappy

      # 버퍼 크기
      buffer-memory: 33554432

      # Serializer
      key-serializer: org.apache.kafka.common.serialization.StringSerializer
      value-serializer: org.apache.kafka.common.serialization.StringSerializer

      # ========================================
      # 추가 설정
      # ========================================

      properties:
        # 메타데이터 최대 age
        metadata.max.age.ms: 300000

        # 재연결 백오프
        reconnect.backoff.ms: 50
        reconnect.backoff.max.ms: 1000

    consumer:
      # Consumer Group ID (서비스명 자동 사용)
      # ${spring.application.name}으로 각 서비스의 group-id가 자동 설정됨
      group-id: ${spring.application.name}

      # 자동 오프셋 커밋 비활성화 (수동 관리)
      enable-auto-commit: false

      # 오프셋 리셋 정책
      auto-offset-reset: earliest

      # Deserializer
      key-deserializer: org.apache.kafka.common.serialization.StringDeserializer
      value-deserializer: org.apache.kafka.common.serialization.StringDeserializer

      # Poll 설정
      max-poll-records: 500
      max-poll-interval-ms: 300000

      # Fetch 설정
      fetch-min-size: 1
      fetch-max-wait-ms: 500

      properties:
        # Session timeout
        session.timeout.ms: 30000

        # Heartbeat
        heartbeat.interval.ms: 3000
