# Hamster World - MSA E-commerce + Payment System

> **ğŸš€ ìƒˆ ì„¸ì…˜ ì‹œì‘ ì‹œ í•„ë…!**
> 1. ì´ README.md ì½ê¸° (ì „ì²´ ì•„í‚¤í…ì²˜ íŒŒì•…)
> 2. ì‘ì—…í•  ì„œë¹„ìŠ¤ì˜ README.md ì½ê¸° (ìƒì„¸ êµ¬í˜„ì‚¬í•­)
> 3. `## ë‹¤ìŒ ì„¸ì…˜ ì‘ì—… ì¸ìˆ˜ì¸ê³„` ì„¹ì…˜ í™•ì¸

---

## í”„ë¡œì íŠ¸ ê°œìš”

**Hamster World = ê²°ì œ ì¤‘ê°œ í”Œë«í¼ (Payment Gateway Platform)**

í† ìŠ¤í˜ì´ë¨¼ì¸ , ì´ë‹ˆì‹œìŠ¤ì™€ ê°™ì€ **ê²°ì œ ëŒ€í–‰ ì„œë¹„ìŠ¤ (PG Aggregator)** ì•„í‚¤í…ì²˜ë¡œ,
ë²¤ë”(ì‡¼í•‘ëª° ì‚¬ì—…ì)ë“¤ì—ê²Œ **ê²°ì œ/ì •ì‚°/ì¬ê³  ê´€ë¦¬ SaaS**ë¥¼ ì œê³µí•©ë‹ˆë‹¤.

### ë¹„ì¦ˆë‹ˆìŠ¤ ëª¨ë¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hamster World (ê²°ì œ ì¤‘ê°œ í”Œë«í¼)                        â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚  â”œâ”€ Ecommerce Service (ë²¤ë”ìš© SaaS ì‡¼í•‘ëª°)              â”‚
â”‚  â”œâ”€ Cash Gateway Service (ê²°ì œ ë°©í™”ë²½/ì¤‘ê°œ)             â”‚
â”‚  â””â”€ Payment Service (ì •ì‚°/ì¬ê³ /ê¶Œí•œ - ë‚´ë¶€ ì „ìš©)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ ì œê³µ (2ê°€ì§€ ê²°ì œ ê²½ë¡œ)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Vendor A (ì‡¼í•‘ëª° ì‚¬ì—…ì)                               â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”   â”‚
â”‚  ì„ íƒ 1: ì§ì ‘ PG ê³„ì•½ (ë‚®ì€ ìˆ˜ìˆ˜ë£Œ, ê²½ë¡œ A)             â”‚
â”‚          â””â”€ Ecommerce â†’ ì™¸ë¶€ PG â†’ Cash Gateway (ë…¸í‹°)  â”‚
â”‚                                                         â”‚
â”‚  ì„ íƒ 2: Hamster ì¤‘ê°œ (ë†’ì€ ìˆ˜ìˆ˜ë£Œ, ê²½ë¡œ B)             â”‚
â”‚          â””â”€ Ecommerce â†’ Cash Gateway â†’ ì™¸ë¶€ PG         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ ëª¨ë“  ê²°ì œ ì´ë²¤íŠ¸ ì§‘í•©
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì™¸ë¶€ PG (Hamster PG ì‹œë®¬ë ˆì´í„°)                        â”‚
â”‚  - ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  í† ìŠ¤/ì´ë‹ˆì‹œìŠ¤/NHN KCP ë“±              â”‚
â”‚  - ì´ í”„ë¡œì íŠ¸ì—ì„  ì‹œë®¬ë ˆì´í„°ë¡œ ì™¸ë¶€ PG ì—­í•              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì•„í‚¤í…ì²˜ ë‹¤ì´ì–´ê·¸ë¨

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              External Client (Vendor/Customer)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚ HTTP
                         â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ecommerce-service   â”‚  â† ë²¤ë”ìš© SaaS ì‡¼í•‘ëª°
              â”‚  (PORT: 8081)        â”‚     Product Catalog (Read)
              â”‚  [PUBLIC]            â”‚     Cart, Order (ì „í‘œ)
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     User (CUSTOMER/VENDOR)
                     â”‚
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ ê²½ë¡œ A    â”‚ ê²½ë¡œ B   â”‚
          â”‚ (ì§ì ‘)   â”‚ (ì¤‘ê°œ)   â”‚
          â†“          â†“          â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ì™¸ë¶€ PG â”‚  â”‚ cash-gateway-service â”‚  â† ê²°ì œ ë°©í™”ë²½/ì¤‘ê°œ
    â”‚ (ì§ì ‘)  â”‚  â”‚  (PORT: 8082)        â”‚     PaymentAttempt (Source of Truth)
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â”‚  [INTERNAL ADMIN]    â”‚     ë³µì¡í•œ ê²°ì œ ë¡œì§/ê²€ì¦
         â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     ì •ì‚° ìˆ˜ìˆ˜ë£Œ ê³„ì‚°
         â”‚ Webhook     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                       â”‚ HTTP (PG í†µì‹ )
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  hamster-pg      â”‚  â† ì™¸ë¶€ PG ì‹œë®¬ë ˆì´í„°
              â”‚  (PORT: 8083)    â”‚     (ì‹¤ì œë¡  Hamster ì†Œìœ  ì•„ë‹˜)
              â”‚  [EXTERNAL]      â”‚     í† ìŠ¤/ì´ë‹ˆì‹œìŠ¤ ë“± ì—­í• 
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Webhook
                       â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ cash-gateway-service â”‚
              â”‚   (ê²°ê³¼ ìˆ˜ì‹ )         â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Kafka Events
                     â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚ payment-service     â”‚  â† ì •ì‚°/ì¬ê³ /ê¶Œí•œ (ë‚´ë¶€ ì „ìš©)
              â”‚  (PORT: 8084)       â”‚     Stock Management (Write)
              â”‚  [INTERNAL ONLY]    â”‚     Event Sourcing (ProductRecord)
              â”‚  REACTIVE ONLY      â”‚     Pessimistic Lock
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ Kafka Events
                     â†“
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚  ecommerce-service   â”‚  â† Consumer (ì¬ê³  ì‹±í¬)
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì„œë¹„ìŠ¤ ì—­í• 

| ì„œë¹„ìŠ¤ | ë…¸ì¶œ ëŒ€ìƒ | ì—­í•  | ë¹„ê³  |
|--------|----------|------|------|
| **ecommerce-service** | ğŸŒ ì™¸ë¶€ (ë²¤ë”/ê³ ê°) | ë²¤ë”ìš© SaaS ì‡¼í•‘ëª° | Product Catalog, Cart, Order |
| **cash-gateway-service** | ğŸ”’ ë‚´ë¶€ (ìš´ì˜ì§„) | ê²°ì œ ë°©í™”ë²½/ì¤‘ê°œ | PaymentAttempt (Source of Truth) |
| **payment-service** | ğŸ”’ ë‚´ë¶€ (ìš´ì˜ì§„) | ì •ì‚°/ì¬ê³ /ê¶Œí•œ | Event Sourcing, Kafka Only |
| **hamster-pg** | ğŸŒ ì™¸ë¶€ (ì œ3ì PG) | ì™¸ë¶€ PG ì‹œë®¬ë ˆì´í„° | ì‹¤ì œë¡  í† ìŠ¤/ì´ë‹ˆì‹œìŠ¤ ë“± |

### í•µì‹¬ íŠ¹ì§•
- âœ… **ê²°ì œ ì¤‘ê°œ í”Œë«í¼**: ë²¤ë”ë“¤ì´ ì§ì ‘ PG ê³„ì•½ ë˜ëŠ” Hamster ì¤‘ê°œ ì„ íƒ ê°€ëŠ¥
- âœ… **DDD (Domain-Driven Design)**: Aggregate Root + Domain Events
- âœ… **Event Sourcing**: ProductRecord ê¸°ë°˜ ì¬ê³  ì´ë ¥ ì¶”ì 
- âœ… **CQRS**: Ecommerce (Read) vs Payment (Write) ë¶„ë¦¬
- âœ… **Eventual Consistency**: Kafka ê¸°ë°˜ ì¬ê³  ë™ê¸°í™”
- âœ… **Reactive Architecture**: Payment ServiceëŠ” Kafkaë§Œ êµ¬ë… (HTTP ë…¸ì¶œ ì•ˆ í•¨)

---

## ğŸ¯ í•µì‹¬ ì•„í‚¤í…ì²˜ ê²°ì •ì‚¬í•­

---

## âš ï¸ **CRITICAL: Public ID ì •ì±… (ì ˆëŒ€ ì••ì¶•/ìŠ¤í‚µ ê¸ˆì§€!)** âš ï¸

> **ğŸš¨ ë‹¤ìŒ Claude ì„¸ì…˜ì—ê²Œ:**
>
> **ì´ ì„¹ì…˜ì€ ì ˆëŒ€ë¡œ ìš”ì•½í•˜ê±°ë‚˜ ì••ì¶•í•˜ê±°ë‚˜ ìŠ¤í‚µí•˜ì§€ ë§ˆì„¸ìš”!**
>
> ì´ ì •ì±…ì„ ìœ„ë°˜í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ì— Internal PKê°€ ë…¸ì¶œë˜ì–´ ë³´ì•ˆ ë¬¸ì œê°€ ë°œìƒí•©ë‹ˆë‹¤.
> ëª¨ë“  Response DTO ì‘ì„± ì‹œ ë°˜ë“œì‹œ ì´ ê·œì¹™ì„ ë”°ë¼ì•¼ í•©ë‹ˆë‹¤.

### ğŸ“‹ ê·œì¹™: ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸ ì‘ë‹µ ì‹œ Long ID ë…¸ì¶œ ê¸ˆì§€

**ì ˆëŒ€ ì›ì¹™:**
```
âœ… ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸: Public ID (Snowflake Base62)ë§Œ ë°˜í™˜
âŒ ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸: Long Internal PK ë…¸ì¶œ ê¸ˆì§€
```

**ì ìš© ë²”ìœ„:**
- ëª¨ë“  HTTP Response DTO
- ëª¨ë“  Kafka Event Payload (ì™¸ë¶€ ì‹œìŠ¤í…œ ì „ë‹¬ìš©)
- ëª¨ë“  í´ë¼ì´ì–¸íŠ¸ê°€ ë³¼ ìˆ˜ ìˆëŠ” ë°ì´í„°

**ì˜ˆì™¸ (Long ID í—ˆìš©):**
- ì„œë²„ ë‚´ë¶€ ë„ë©”ì¸ ëª¨ë¸
- Repository ë ˆì´ì–´
- Service ë ˆì´ì–´ (ë„ë©”ì¸ ëª¨ë¸ ê°„ í†µì‹ )
- Database ìŠ¤í‚¤ë§ˆ

### ğŸ” ì˜ëª»ëœ ì˜ˆì‹œ vs ì˜¬ë°”ë¥¸ ì˜ˆì‹œ

#### âŒ ì˜ëª»ëœ Response DTO
```kotlin
// BAD: Internal PK ë…¸ì¶œ
data class OrderResponse(
    val id: Long,              // âŒ Internal PK ë…¸ì¶œ
    val userId: Long,          // âŒ Foreign Key ë…¸ì¶œ
    val orderNumber: String,
    val totalPrice: BigDecimal
)
```

#### âœ… ì˜¬ë°”ë¥¸ Response DTO
```kotlin
// GOOD: Public IDë§Œ ë…¸ì¶œ
data class OrderResponse(
    val orderPublicId: String,     // âœ… Public ID (Snowflake Base62)
    val userPublicId: String,      // âœ… Userì˜ Public ID
    val orderNumber: String,
    val totalPrice: BigDecimal
) {
    companion object {
        fun from(order: Order, user: User): OrderResponse {
            return OrderResponse(
                orderPublicId = order.publicId,
                userPublicId = user.publicId,  // User ì¡°íšŒ í•„ìš”
                orderNumber = order.orderNumber,
                totalPrice = order.totalPrice
            )
        }
    }
}
```

### ğŸ› ï¸ Response DTO ì‘ì„± ê°€ì´ë“œ

#### 1. Long FKë¥¼ Public IDë¡œ ë³€í™˜í•˜ëŠ” íŒ¨í„´

**Service ë ˆì´ì–´ì—ì„œ Batch ì¡°íšŒ:**
```kotlin
@Service
class BoardService(...) {

    @Transactional(readOnly = true)
    fun searchPage(request: BoardSearchRequest): Page<BoardWithPublicIds> {
        val boardsPage = boardRepository.searchPage(request)

        // Batch ì¡°íšŒë¡œ N+1 ë°©ì§€
        val productIds = boardsPage.content.map { it.productId }.distinct()
        val authorIds = boardsPage.content.map { it.authorId }.distinct()

        val products = productRepository.findByIds(productIds).associateBy { it.id!! }
        val users = userRepository.findByIds(authorIds).associateBy { it.id!! }

        return boardsPage.map { board ->
            BoardWithPublicIds(
                board = board,
                productPublicId = products[board.productId]!!.publicId,
                authorPublicId = users[board.authorId]!!.publicId
            )
        }
    }

    data class BoardWithPublicIds(
        val board: Board,
        val productPublicId: String,
        val authorPublicId: String
    )
}
```

**Controllerì—ì„œ Response ìƒì„±:**
```kotlin
@RestController
class BoardController(...) {

    @GetMapping("/page")
    fun searchBoardsPage(request: BoardSearchRequest): ResponseEntity<Page<BoardResponse>> {
        val boards = boardService.searchPage(request)

        val responses = boards.map {
            BoardResponse.from(
                it.board,
                it.productPublicId,
                it.authorPublicId
            )
        }

        return ResponseEntity.ok(responses)
    }
}
```

#### 2. Repositoryì— findByIds() ë©”ì„œë“œ í•„ìˆ˜

**ëª¨ë“  Repositoryì— Batch ì¡°íšŒ ë©”ì„œë“œ ì¶”ê°€:**
```kotlin
@Repository
class UserRepository(...) {

    fun findByIds(ids: List<Long>): List<User> {
        if (ids.isEmpty()) return emptyList()
        return jpaQueryFactory
            .selectFrom(user)
            .where(user.id.`in`(ids))
            .fetch()
    }
}
```

### ğŸ“ ì²´í¬ë¦¬ìŠ¤íŠ¸ (Response DTO ì‘ì„± ì‹œ)

**ìƒˆë¡œìš´ Response DTO ì‘ì„± ì „ í™•ì¸:**
- [ ] Long íƒ€ì… ID í•„ë“œê°€ ìˆëŠ”ê°€? â†’ ì œê±° ë˜ëŠ” Public IDë¡œ ë³€ê²½
- [ ] Long íƒ€ì… FK í•„ë“œê°€ ìˆëŠ”ê°€? â†’ í•´ë‹¹ ì—”í‹°í‹°ì˜ Public IDë¡œ ë³€ê²½
- [ ] `from()` íŒ©í† ë¦¬ ë©”ì„œë“œì—ì„œ í•„ìš”í•œ ì—”í‹°í‹°ë¥¼ ëª¨ë‘ ë°›ëŠ”ê°€?
- [ ] Serviceì—ì„œ Batch ì¡°íšŒë¡œ N+1ì„ ë°©ì§€í•˜ëŠ”ê°€?
- [ ] Repositoryì— `findByIds()` ë©”ì„œë“œê°€ ìˆëŠ”ê°€?

**ê¸°ì¡´ Response DTO ìˆ˜ì • ì‹œ í™•ì¸:**
- [ ] ê¸°ì¡´ Long ID í•„ë“œë¥¼ Public IDë¡œ ë³€ê²½í–ˆëŠ”ê°€?
- [ ] í´ë¼ì´ì–¸íŠ¸ ì½”ë“œê°€ ì˜í–¥ë°›ì§€ ì•Šë„ë¡ í•„ë“œëª…ì„ ì ì ˆíˆ ë³€ê²½í–ˆëŠ”ê°€?
- [ ] API ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í–ˆëŠ”ê°€?

### ğŸ”§ Migration ì˜ˆì‹œ (Board/Comment)

**Before (ì˜ëª»ëœ êµ¬í˜„):**
```kotlin
// âŒ Long ID ë…¸ì¶œ
data class BoardResponse(
    val publicId: String,
    val productPublicId: String,
    val authorPublicId: String,
    // ...
) {
    companion object {
        fun from(board: Board): BoardResponse {
            return BoardResponse(
                publicId = board.publicId,
                productPublicId = board.productId.toString(),  // âŒ Long â†’ String ë‹¨ìˆœ ë³€í™˜
                authorPublicId = board.authorId.toString(),    // âŒ Long â†’ String ë‹¨ìˆœ ë³€í™˜
                // ...
            )
        }
    }
}
```

**After (ì˜¬ë°”ë¥¸ êµ¬í˜„):**
```kotlin
// âœ… Public IDë§Œ ë…¸ì¶œ
data class BoardResponse(
    val publicId: String,
    val productPublicId: String,
    val authorPublicId: String,
    val commentCount: Int,
    // ...
) {
    companion object {
        fun from(
            board: Board,
            productPublicId: String,  // âœ… ì´ë¯¸ ë³€í™˜ëœ Public ID
            authorPublicId: String,   // âœ… ì´ë¯¸ ë³€í™˜ëœ Public ID
            commentCount: Int
        ): BoardResponse {
            return BoardResponse(
                publicId = board.publicId,
                productPublicId = productPublicId,
                authorPublicId = authorPublicId,
                commentCount = commentCount,
                // ...
            )
        }
    }
}

// Serviceì—ì„œ Public ID ë³€í™˜
@Service
class BoardService(...) {
    fun searchPage(request: BoardSearchRequest): Page<BoardWithPublicIds> {
        val boards = boardRepository.searchPage(request)

        val productIds = boards.content.map { it.productId }.distinct()
        val authorIds = boards.content.map { it.authorId }.distinct()

        val products = productRepository.findByIds(productIds).associateBy { it.id!! }
        val users = userRepository.findByIds(authorIds).associateBy { it.id!! }

        return boards.map { board ->
            BoardWithPublicIds(
                board = board,
                productPublicId = products[board.productId]!!.publicId,
                authorPublicId = users[board.authorId]!!.publicId,
                commentCount = commentRepository.countByBoardId(board.id!!)
            )
        }
    }
}
```

### ğŸš¨ ìœ„ë°˜ ì‹œ ë¬¸ì œì 

1. **ë³´ì•ˆ ë¬¸ì œ**: Internal PK ë…¸ì¶œë¡œ DB êµ¬ì¡° ì¶”ì¸¡ ê°€ëŠ¥
2. **Migration ë¶ˆê°€**: Auto-increment PKëŠ” ë³€ê²½ ë¶ˆê°€ (vs Public IDëŠ” ë³€ê²½ ê°€ëŠ¥)
3. **ìŠ¤ì¼€ì¼ë§ ì œì•½**: Sharding ì‹œ PK ì¶©ëŒ ê°€ëŠ¥ì„±
4. **í´ë¼ì´ì–¸íŠ¸ ì˜ì¡´ì„±**: DB PK ë³€ê²½ ì‹œ í´ë¼ì´ì–¸íŠ¸ ì½”ë“œ ì˜í–¥

### ğŸ“š ì°¸ê³  íŒŒì¼

**Public ID ì˜¬ë°”ë¥´ê²Œ ì ìš©ëœ ì˜ˆì‹œ:**
- `/Users/mac/IdeaProjects/hamster-world/ecommerce-service/src/main/kotlin/com/hamsterworld/ecommerce/app/board/response/BoardResponse.kt`
- `/Users/mac/IdeaProjects/hamster-world/ecommerce-service/src/main/kotlin/com/hamsterworld/ecommerce/app/comment/response/CommentResponse.kt`
- `/Users/mac/IdeaProjects/hamster-world/ecommerce-service/src/main/kotlin/com/hamsterworld/ecommerce/domain/board/service/BoardService.kt`
- `/Users/mac/IdeaProjects/hamster-world/ecommerce-service/src/main/kotlin/com/hamsterworld/ecommerce/domain/comment/service/CommentService.kt`

---

### 1. **Product + Stockì€ ë¶„ë¦¬ ë¶ˆê°€**
```
âœ… Product.stockì€ Productì˜ ì¼ë¶€
âœ… ê°™ì€ íŠ¸ëœì­ì…˜ì—ì„œ ì¬ê³  ì°¨ê° (ì›ìì„±)
âŒ ë¶„ë¦¬ ì‹œ Race Condition â†’ ì´ˆê³¼ íŒë§¤ ë°œìƒ
```

**ê·¼ê±°:**
```kotlin
@Transactional
fun reserveStock(productId: Long, quantity: Int) {
    val product = productRepository.findByIdForUpdate(productId)  // Pessimistic Lock
    if (product.stock < quantity) throw InsufficientStockException()
    product.stock -= quantity  // ê°™ì€ íŠ¸ëœì­ì…˜!
}
```

### 2. **Order vs PaymentAttempt (Source of Truth)**

| ë„ë©”ì¸ | ì—­í•  | ì¤‘ìš”ë„ |
|--------|------|--------|
| **Order** (ecommerce) | ì‚¬ìš©ì ì „í‘œ/ì˜ìˆ˜ì¦ | UIìš© ë°ì´í„° |
| **PaymentAttempt** (cash-gateway) | ì‹¤ì œ ê±°ë˜ ê¸°ë¡ | Source of Truth â­ |

**í•µì‹¬:**
- Order = ì‚¬ìš©ìê°€ "ë‚´ ì£¼ë¬¸ ë‚´ì—­" ë³¼ ë•Œë§Œ ì‚¬ìš©
- PaymentAttempt = PG ìš”ì²­/ì‘ë‹µ ì¶”ì , ì¬ê³  ì°¨ê°ì˜ íŠ¸ë¦¬ê±°
- **Payment ServiceëŠ” Orderë¥¼ ì „í˜€ ëª¨ë¦„!**

### 3. **Payment ServiceëŠ” ë¦¬ì•¡í‹°ë¸Œ ì „ìš©**
```
âœ… Kafka ì´ë²¤íŠ¸ êµ¬ë…ë§Œ í—ˆìš©
âŒ HTTP API í˜¸ì¶œ ê¸ˆì§€
âŒ Order ì§ì ‘ ì°¸ì¡° ê¸ˆì§€
```

**ì˜ì¡´ ê´€ê³„:**
```
Payment Serviceê°€ ì•„ëŠ” ê²ƒ:
  âœ… paymentAttemptId
  âœ… productId, quantity (ì´ë²¤íŠ¸ë¡œ ì „ë‹¬ë°›ìŒ)
  âœ… Product, Stock

Payment Serviceê°€ ëª¨ë¥´ëŠ” ê²ƒ:
  âŒ Order
  âŒ User
  âŒ Cart
```

### 4. **ì¬ê³  ì„ ì°¨ê° ì „ëµ (Pre-deduction)**

```
ì„ ì°¨ê° ì‹œì : PaymentAttempt ìƒì„± ì‹œ (PG ìš”ì²­ ì „)
ë³µêµ¬ ì‹œì : PG ì‹¤íŒ¨ ë˜ëŠ” ì·¨ì†Œ ì‹œ
```

**í”Œë¡œìš°:**
```
1. PaymentAttempt ìƒì„±
   â†“ Kafka: StockReservationRequestedEvent
2. Payment Service: ì¬ê³  ì°¨ê° (ì„ ì°¨ê°)
   â†“ Kafka: StockReservedEvent
3. Cash Gateway: PG ìš”ì²­
   â†“
4-a. PG ì„±ê³µ â†’ ì¬ê³  í™•ì • (ë¡œê·¸ë§Œ, ì´ë¯¸ ì°¨ê°ë¨)
4-b. PG ì‹¤íŒ¨ â†’ ì¬ê³  ë³µêµ¬ (+)
4-c. PG ì·¨ì†Œ â†’ ì¬ê³  ë³µêµ¬ (+)
```

**ë©±ë“±ì„± ë³´ì¥:**
```kotlin
// ProductRecord reasonì— attemptId í¬í•¨
"[ì„ ì°¨ê°] attemptId=${paymentAttemptId}"
"[ë³µêµ¬] attemptId=${paymentAttemptId}"

// ì¤‘ë³µ ì²˜ë¦¬ ë°©ì§€
if (existsByReason("[ì„ ì°¨ê°] attemptId=$attemptId")) {
    log.warn("Already processed")
    return
}
```

---

## ì„œë¹„ìŠ¤ êµ¬ì„±

### 1. **ecommerce-service** (PORT: 8081) ğŸŒ PUBLIC
**ì—­í• :** ë²¤ë”ìš© SaaS ì‡¼í•‘ëª° (ì™¸ë¶€ ë…¸ì¶œ)
- ì¥ë°”êµ¬ë‹ˆ (Cart, CartItem)
- **ì£¼ë¬¸ ê´€ë¦¬ (Order, OrderItem)** â† ì „í‘œ/ì˜ìˆ˜ì¦ ìš©ë„
- ì‚¬ìš©ì ì¸ì¦ (User)
  - `role: CUSTOMER` (ì¼ë°˜ êµ¬ë§¤ì)
  - `role: VENDOR` (ì‡¼í•‘ëª° ì‚¬ì—…ì)

**íŠ¹ì§•:**
- ğŸŒ **PUBLIC ì„œë¹„ìŠ¤** (ë²¤ë”/ê³ ê° ëª¨ë‘ ì ‘ê·¼)
- 2ê°€ì§€ ê²°ì œ ê²½ë¡œ ì œê³µ:
  - **ê²½ë¡œ A (ì§ì ‘ PG)**: ë²¤ë”ê°€ PG ì§ì ‘ ê³„ì•½ (ë‚®ì€ ìˆ˜ìˆ˜ë£Œ)
  - **ê²½ë¡œ B (Hamster ì¤‘ê°œ)**: Cash Gateway ê²½ìœ  (ë†’ì€ ìˆ˜ìˆ˜ë£Œ)
- ì¬ê³ ëŠ” ì½ê¸° ì „ìš© ìºì‹œ (Payment Serviceë¡œë¶€í„° ë™ê¸°í™”)
- OrderëŠ” ë‹¨ìˆœ ì „í‘œ/ì˜ìˆ˜ì¦ ìš©ë„

**ğŸ“– ìƒì„¸ ë¬¸ì„œ:** [ecommerce-service/README.md](./ecommerce-service/README.md)

**Orderì˜ ì—­í• :**
```
âœ… ì‚¬ìš©ìê°€ ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ
âœ… Cash Gatewayì— ì „ë‹¬ë˜ëŠ” ë©”íƒ€ë°ì´í„°
âŒ ì¬ê³  ì°¨ê° ê¸°ì¤€ (X) â† Payment Service ë‹´ë‹¹
âŒ ê±°ë˜ì˜ Source of Truth (X) â† Cash Gateway ë‹´ë‹¹
```

**Frontend:**
```
Vendor Admin Portal
â”œâ”€ ìƒí’ˆ ê´€ë¦¬ (VENDOR)
â”œâ”€ ì£¼ë¬¸ ë‚´ì—­ ì¡°íšŒ
â”œâ”€ ì •ì‚° ë‚´ì—­ ì¡°íšŒ (ì½ê¸° ì „ìš©)
â””â”€ ê²°ì œ ê²½ë¡œ ì„¤ì • (ì§ì ‘/ì¤‘ê°œ)
```

---

### 2. **cash-gateway-service** (PORT: 8082) ğŸ”’ INTERNAL ADMIN
**ì—­í• :** ê²°ì œ ë°©í™”ë²½ + ì¤‘ê°œ í”Œë«í¼ (Source of Truth â­)
- **PaymentAttempt** - PG í†µì‹  ì´ë ¥ (Mutable, 1:1)
- **Payment** - ë¶ˆë³€ ê±°ë˜ ê¸°ë¡ (Immutable)
- **PgMerchantMapping** - MIDì™€ ê±°ë˜ ì¶œì²˜ ë§¤í•‘
- PGì‚¬ ì—°ë™ (ë™ê¸°/ë¹„ë™ê¸° ì§€ì›)
- ì™¸ë¶€ íŒŒíŠ¸ë„ˆ ì •ì‚° ê¸°ë¡
- MID ê¸°ë°˜ ê±°ë˜ ì¶œì²˜ ìë™ íŒë³„
- ë³µì¡í•œ ê²°ì œ ë¡œì§/ê²€ì¦ ì²˜ë¦¬
- ì •ì‚° ìˆ˜ìˆ˜ë£Œ ê³„ì‚°

**íŠ¹ì§•:**
- ğŸ”’ **INTERNAL ADMIN** (Hamster World ìš´ì˜ì§„ë§Œ ì ‘ê·¼)
- ëª¨ë“  ê²°ì œ ì´ë²¤íŠ¸ì˜ ì§‘í•©ì  (ê²½ë¡œ A/B ëª¨ë‘)
- Payment Serviceì— Kafka ì´ë²¤íŠ¸ ë°œí–‰
- ì‚¬ìš©ìëŠ” ì§ì ‘ ì ‘ê·¼ ë¶ˆê°€ (Ecommerceë¥¼ í†µí•´ì„œë§Œ)

**ğŸ“– ìƒì„¸ ë¬¸ì„œ:** [cash-gateway-service/README.md](./cash-gateway-service/README.md)

**3ê°€ì§€ ìš´ì˜ ëª¨ë“œ:**
```
1. Active Mode (PG ëŒ€í–‰ - ê²½ë¡œ B)
   Ecommerce â†’ Cash Gateway â†’ PG â†’ Webhook â†’ Payment

2. Webhook Mode (ì™¸ë¶€ ê±°ë˜ - ê²½ë¡œ A)
   ì™¸ë¶€ PG â†’ Webhook â†’ Cash Gateway â†’ Payment

3. Passive Mode (ì •ì‚° ê¸°ë¡)
   Partner Service â†’ /record API â†’ Cash Gateway â†’ Payment
```

**ì•„í‚¤í…ì²˜ ì›ì¹™:**
```
âœ… PaymentAttempt: ëª¨ë“  PaymentëŠ” Attempt í•„ìˆ˜ (1:1)
âœ… PaymentAttempt: Mutable (UNKNOWN â†’ SUCCESS via CAS)
âœ… Payment: Immutable (ì·¨ì†Œë„ ìƒˆ ë ˆì½”ë“œ, originPaymentId)
âœ… ë©±ë“±ì„±: pgTransaction (UNIQUE ì œì•½)
âŒ Event Sourcing ì•„ë‹˜ (Paymentê°€ ë…ë¦½ ê±°ë˜)
```

**PaymentAttempt êµ¬ì¡°:**
```kotlin
PaymentAttempt(
    id: Long,
    orderId: Long?,  // nullable (ì™¸ë¶€ ê±°ë˜)
    userId: Long?,
    provider: Provider?,
    mid: String,  // MID (Merchant ID)
    amount: BigDecimal,
    status: PaymentAttemptStatus,  // UNKNOWN, SUCCESS, FAILED, CANCELLED
    pgTransaction: String?,  // ë©±ë“±ì„± í‚¤ (tid or externalTxnId)
    isExternal: Boolean,  // Webhook/Passive êµ¬ë¶„
    originSource: String?,  // null = ë‚´ë¶€, "partner-a" = ì™¸ë¶€
    originAttemptId: Long?  // ì·¨ì†Œ ì‹œ ì›ë³¸ Attempt
)
```

**Payment êµ¬ì¡° (ë¶ˆë³€):**
```kotlin
Payment(
    id: Long,
    attemptId: Long,  // PaymentAttempt FK (1:1)
    mid: String?,  // MID (Merchant ID)
    amount: BigDecimal,  // ì–‘ìˆ˜(ìŠ¹ì¸) or ìŒìˆ˜(ì·¨ì†Œ)
    status: PaymentStatus,  // APPROVED, CANCELLED
    originPaymentId: Long?,  // ì·¨ì†Œê±´ì´ë©´ ì›ë³¸ Payment
    isExternal: Boolean,
    originSource: String?  // null = ë‚´ë¶€, "partner-a" = ì™¸ë¶€
)

// í˜„ì¬ ì”ì•¡ = SUM(amount) WHERE id = 1 OR originPaymentId = 1
```

**Frontend:**
```
Internal Admin Portal (Cash Gateway ì„¹ì…˜)
â”œâ”€ ğŸ’³ ê²°ì œ ëª¨ë‹ˆí„°ë§ (ì‹¤ì‹œê°„)
â”œâ”€ ğŸ”§ PG ì„¤ì • ê´€ë¦¬
â”œâ”€ ğŸ“Š ì •ì‚° ì²˜ë¦¬
â”œâ”€ ğŸ” Webhook ë¡œê·¸ ì¡°íšŒ
â””â”€ ğŸª ê°€ë§¹ì (MID) ê´€ë¦¬
```

---

### 3. **payment-service** (PORT: 8084) ğŸ”’ INTERNAL ONLY
**ì—­í• :** ì •ì‚°/ì¬ê³ /ê¶Œí•œ ê´€ë¦¬ (ì™„ì „ ë‚´ë¶€ ì „ìš©)
- **Product** - ìƒí’ˆ ë§ˆìŠ¤í„° (stock í¬í•¨)
- **ProductRecord** - ì¬ê³  ë³€ë™ ì´ë ¥ (ì´ë²¤íŠ¸ ì†Œì‹± - Delta ë°©ì‹)
- **OrderSnapshot** - ì£¼ë¬¸ ìŠ¤ëƒ…ìƒ· (ê²°ì œ ì·¨ì†Œ ì‹œ ì¬ê³  ë³µì›ìš©)
- ì¬ê³  íŠ¸ëœì­ì…˜ ì¶”ì  (ë©±ë“±ì„±)
- ì •ì‚° ê³„ì‚° ë¡œì§
- ê¶Œí•œ ê´€ë¦¬

**íŠ¹ì§•:**
- ğŸ”’ **INTERNAL ONLY** (HTTP API ë…¸ì¶œ ì•ˆ í•¨!)
- **ë¦¬ì•¡í‹°ë¸Œ ì „ìš©** - Kafka ì´ë²¤íŠ¸ë§Œ êµ¬ë…
- Order ì§ì ‘ ì°¸ì¡° ê¸ˆì§€
- Two-Phase Locking (Deadlock ë°©ì§€)
- Event Sourcing (ProductRecord - Delta ë°©ì‹)
- **ì‚¬ìš©ìëŠ” ì¡´ì¬ì¡°ì°¨ ëª¨ë¥´ëŠ” ì„œë¹„ìŠ¤** (Ecommerceë¥¼ í†µí•´ ê°„ì ‘ ì‚¬ìš©)

**ğŸ“– ìƒì„¸ ë¬¸ì„œ:** [payment-service/README.md](./payment-service/README.md)

**êµ¬ë… ì´ë²¤íŠ¸:**
```kotlin
@KafkaListener("ecommerce-events")
fun handleOrderCreated(event: OrderCreatedEvent) {
    // ì¬ê³  ê²€ì¦ + ì„ ì°¨ê° (Two-Phase Locking)
    // â†’ OrderSnapshot ì €ì¥
    // â†’ OrderStockReservedEvent ë°œí–‰
}

@KafkaListener("cash-gateway-events")
fun handlePaymentCancelled(event: PaymentCancelledEvent) {
    // OrderSnapshot ì¡°íšŒ
    // â†’ ì¬ê³  ë³µì› (+)
}
```

**ì´ë²¤íŠ¸ ì†Œì‹± (Delta ë°©ì‹):**
```sql
-- ProductRecord (ë³€í™”ëŸ‰ ì €ì¥)
INSERT INTO product_records (product_id, stock, reason)
VALUES (1, +100, 'ì´ˆê¸° ì¬ê³  ì„¤ì •');

INSERT INTO product_records (product_id, stock, reason)
VALUES (1, -5, '[ì£¼ë¬¸ ì°¨ê°] orderId=123');

INSERT INTO product_records (product_id, stock, reason)
VALUES (1, +5, '[ê²°ì œ ì·¨ì†Œ ë³µì›] orderId=123');

-- Product.stock = SUM(ProductRecord.stock)
-- ì¬ì§‘ê³„: 100 - 5 + 5 = 100
```

**OrderSnapshot êµ¬ì¡°:**
```
product_order_snapshots (ë¶€ëª¨)
  - order_id, order_number, user_id, total_price

product_order_snapshot_items (ìì‹, FK ì—†ìŒ)
  - snapshot_id, product_id, quantity, price
```

**Frontend:**
```
Internal Admin Portal (Payment ì„¹ì…˜)
â”œâ”€ ğŸ“¦ ì¬ê³  ê´€ë¦¬ (ì „ì²´ ì¬ê³  í˜„í™©)
â”œâ”€ ğŸ“ ì¬ê³  ì¡°ì • ì´ë ¥ (Event Sourcing)
â”œâ”€ ğŸ’° ì •ì‚° ê³„ì‚° ê´€ë¦¬
â””â”€ ğŸ” ê¶Œí•œ ì„¤ì •
```

---

### 4. **hamster-pg-service** (PORT: 8083) ğŸŒ EXTERNAL (ì‹œë®¬ë ˆì´í„°)
**ì—­í• :** ì™¸ë¶€ PG ì‹œë®¬ë ˆì´í„° (ì‹¤ì œë¡  Hamster ì†Œìœ  ì•„ë‹˜)
- ê°€ë§¹ì  ê´€ë¦¬ (PgMid)
- ê²°ì œ ì²˜ë¦¬ (Payment)
- Webhook ì „ì†¡

**íŠ¹ì§•:**
- ğŸŒ **EXTERNAL** (ì œ3ì PG ì—­í• )
- ì‹¤ì œ ì„œë¹„ìŠ¤ì—ì„  **í† ìŠ¤í˜ì´ë¨¼ì¸ , ì´ë‹ˆì‹œìŠ¤, NHN KCP** ë“±
- ì´ í”„ë¡œì íŠ¸ì—ì„  ì‹œë®¬ë ˆì´í„°ë¡œ ì™¸ë¶€ PG ì—­í•  ìˆ˜í–‰
- ë¹„ë™ê¸° ì²˜ë¦¬ (Scheduler ê¸°ë°˜, 1ì´ˆ í´ë§)
- HMAC-SHA256 ì¸ì¦
- Hamster Worldì™€ **ë…ë¦½ëœ ì„œë¹„ìŠ¤**ë¡œ ê°„ì£¼

**ğŸ“– ìƒì„¸ ë¬¸ì„œ:** [hamster-pg-service/README.md](./hamster-pg-service/README.md)

**API ì—”ë“œí¬ì¸íŠ¸:**
```
POST   /api/payment       ê²°ì œ ìƒì„±/ì·¨ì†Œ
GET    /api/payment/list  ê²°ì œ ë‚´ì—­ ì¡°íšŒ
POST   /api/mid           ê°€ë§¹ì  ìƒì„±
GET    /api/mid/list      ê°€ë§¹ì  ëª©ë¡
```

**ì£¼ì˜:**
- ì´ ì„œë¹„ìŠ¤ëŠ” Hamster Worldì˜ ì¼ë¶€ê°€ **ì•„ë‹˜**
- ì‹¤ì œ í™˜ê²½ì—ì„  í† ìŠ¤/ì´ë‹ˆì‹œìŠ¤ ë“± ì™¸ë¶€ PGì‚¬ API
- í•™ìŠµ/í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œë§Œ í”„ë¡œì íŠ¸ì— í¬í•¨

---

## í•µì‹¬ ì•„í‚¤í…ì²˜ ì›ì¹™

### 1. ì´ë²¤íŠ¸ ê¸°ë°˜ í†µì‹ 
```
ë™ê¸° (HTTP):
  - ecommerce â†’ cash-gateway
  - cash-gateway â†’ hamster-pg

ë¹„ë™ê¸° (Kafka):
  - cash-gateway â†’ payment-service (ë¦¬ì•¡í‹°ë¸Œ ì „ìš©!)
```

### 2. ë©±ë“±ì„± ë³´ì¥
```
í‚¤: paymentAttemptId

ë°©ë²•:
  - ProductRecord.reasonì— attemptId í¬í•¨
  - ì¤‘ë³µ ì²˜ë¦¬ ì‹œ WARN ë¡œê·¸ í›„ ìŠ¤í‚µ
  - ì´ë²¤íŠ¸ ì†Œì‹±ìœ¼ë¡œ ì¬ì§‘ê³„ ê°€ëŠ¥
```

### 3. ë°”ìš´ë“œ ì»¨í…ìŠ¤íŠ¸ ë¶„ë¦¬

| ë„ë©”ì¸ | ì†Œìœ  ì„œë¹„ìŠ¤ | ì—­í•  | ì ‘ê·¼ ë°©ë²• |
|--------|------------|------|----------|
| **Order** | ecommerce-service | ì „í‘œ/ì˜ìˆ˜ì¦ | ì´ë²¤íŠ¸ë¡œë§Œ ì „ë‹¬ |
| **PaymentAttempt** | cash-gateway-service | Source of Truth | ì´ë²¤íŠ¸ ë°œí–‰ |
| **Product + Stock** | payment-service | ì¬ê³  ê´€ë¦¬ | ì´ë²¤íŠ¸ë¡œë§Œ ë°˜ì‘ |
| **Payment** | hamster-pg-service | PG ì²˜ë¦¬ | Webhook |

### 4. ì§„ì‹¤ì˜ ì›ì²œ (Source of Truth)
```
PaymentAttempt (cash-gateway) â­
    â†“ Kafka Events
Payment Service (ì¬ê³  ì°¨ê°/ë³µêµ¬)
    â†“
Product + Stock (ì‹¤ì œ ì¬ê³ )
```

---

## ì „ì²´ í”Œë¡œìš° ìƒì„¸

### ì¬ê³  ì„ ì°¨ê° + ê²°ì œ ì„±ê³µ ì¼€ì´ìŠ¤
```
1. [ì‚¬ìš©ì] â†’ ecommerce: ì£¼ë¬¸ ìƒì„±
   - Order ìƒì„± (DB ì €ì¥, ì „í‘œìš©)

2. [ecommerce] â†’ cash-gateway: ê²°ì œ ìš”ì²­ (HTTP)
   - orderId, items: [{productId, quantity, price}], totalAmount

3. [cash-gateway] PaymentAttempt ìƒì„±
   - status: STOCK_RESERVATION_PENDING
   - Kafka ë°œí–‰: StockReservationRequestedEvent
     {
       paymentAttemptId: 123,
       items: [{productId: 1, quantity: 5}]
     }

4. [payment-service] ì¬ê³  ì„ ì°¨ê° (Kafka êµ¬ë…)
   - Product.stock -= 5
   - ProductRecord INSERT: (product_id=1, stock=-5, reason="[ì„ ì°¨ê°] attemptId=123")
   - Kafka ë°œí–‰: StockReservedEvent(attemptId=123)

5. [cash-gateway] ì¬ê³  ì˜ˆì•½ ì„±ê³µ (Kafka êµ¬ë…)
   - PaymentAttempt.status = STOCK_RESERVED
   - hamster-pg ìš”ì²­ (HTTP)

6. [hamster-pg] â†’ 202 Accepted (PENDING)
   - Scheduler 1ì´ˆ í›„ ì²˜ë¦¬ â†’ COMPLETED (80% í™•ë¥ )
   - Webhook ì „ì†¡: cash-gateway

7. [cash-gateway] Webhook ìˆ˜ì‹ 
   - Payment ìƒì„± (status: APPROVED)
   - Kafka ë°œí–‰: PaymentCompletedEvent(attemptId=123)

8. [payment-service] ì¬ê³  í™•ì • (Kafka êµ¬ë…)
   - ë¡œê·¸ë§Œ: "Payment completed: attemptId=123, ì¬ê³  í™•ì •"
   - ì´ë¯¸ ì„ ì°¨ê°í–ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì‘ì—… ì—†ìŒ
```

### ì¬ê³  ì„ ì°¨ê° + ê²°ì œ ì‹¤íŒ¨ ì¼€ì´ìŠ¤
```
1~4. (ìœ„ì™€ ë™ì¼) ì¬ê³  ì„ ì°¨ê° ì™„ë£Œ

5. [cash-gateway] â†’ hamster-pg ìš”ì²­

6. [hamster-pg] â†’ FAILED (20% í™•ë¥ )
   - Webhook ì „ì†¡: cash-gateway

7. [cash-gateway] Webhook ìˆ˜ì‹ 
   - PaymentAttempt.status = FAILED
   - Kafka ë°œí–‰: PaymentFailedEvent(attemptId=123)

8. [payment-service] ì¬ê³  ë³µêµ¬ (Kafka êµ¬ë…)
   - ProductRecordì—ì„œ "[ì„ ì°¨ê°] attemptId=123" ì¡°íšŒ
   - Product.stock += 5 (ë³µêµ¬)
   - ProductRecord INSERT: (product_id=1, stock=+5, reason="[ë³µêµ¬] attemptId=123")
```

### ê²°ì œ ì·¨ì†Œ ì¼€ì´ìŠ¤
```
1. [ì‚¬ìš©ì] â†’ ecommerce: ì·¨ì†Œ ìš”ì²­

2. [ecommerce] â†’ cash-gateway: ì·¨ì†Œ ìš”ì²­

3. [cash-gateway] â†’ hamster-pg: PG ì·¨ì†Œ ìš”ì²­

4. [hamster-pg] â†’ 202 Accepted (CANCEL_PENDING)
   - Scheduler ì²˜ë¦¬ â†’ CANCELLED
   - Webhook ì „ì†¡

5. [cash-gateway] Webhook ìˆ˜ì‹ 
   - Payment ìƒì„± (status: CANCELLED)
   - Kafka ë°œí–‰: PaymentCancelledEvent(attemptId=123)

6. [payment-service] ì¬ê³  ë³µêµ¬ (Kafka êµ¬ë…)
   - ProductRecord ì¡°íšŒ: "[ì„ ì°¨ê°] attemptId=123"
   - Product.stock += 5
   - ProductRecord INSERT: "[ë³µêµ¬] attemptId=123"
```

---

## ê¸°ìˆ  ìŠ¤íƒ

### Backend
- **ì–¸ì–´:** Kotlin
- **í”„ë ˆì„ì›Œí¬:** Spring Boot 3.x
- **ë¹Œë“œ:** Gradle (Multi-module)

### Database
- **MySQL** (ê° ì„œë¹„ìŠ¤ë³„ ë…ë¦½ DB)
  - ecommerce_db (PORT: 3306)
  - cash_gateway_db (PORT: 3307)
  - payment_db (PORT: 3308)
  - hamster_pg_db (PORT: 3309)

### Messaging
- **Kafka** (KRaft mode, Zookeeper ë¶ˆí•„ìš”)
  - PORT: 9092
  - Topics:
    - `stock-reservation-requests`
    - `stock-reserved`
    - `stock-reservation-failed`
    - `payment-completed`
    - `payment-failed`
    - `payment-cancelled`

### Common
- JPA/Hibernate
- QueryDSL
- Jackson (JSON)
- WebClient (ë¹„ë™ê¸° HTTP)

---

## ê°œë°œ í™˜ê²½ ì„¤ì •

### 1. í•„ìˆ˜ ìš”êµ¬ì‚¬í•­
```bash
- JDK 21
- Docker & Docker Compose
- Gradle 8.x
```

### 2. Docker ì¸í”„ë¼ ì‹¤í–‰
```bash
# ëª¨ë“  ì¸í”„ë¼ ì‹œì‘ (DB + Kafka)
docker-compose up -d

# ìƒíƒœ í™•ì¸
docker-compose ps
```

### 3. ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™”
```bash
# ê° ì„œë¹„ìŠ¤ db/ ë””ë ‰í† ë¦¬ì˜ SQL ì‹¤í–‰
mysql -h 127.0.0.1 -P 3309 -u root -p'12555!@' hamster_pg_db < hamster-pg-service/db/pg_mids.sql
mysql -h 127.0.0.1 -P 3309 -u root -p'12555!@' hamster_pg_db < hamster-pg-service/db/payments.sql
```

### 4. ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰
```bash
# ê° ì„œë¹„ìŠ¤ ê°œë³„ ì‹¤í–‰
./gradlew :hamster-pg-service:bootRun
./gradlew :ecommerce-service:bootRun
./gradlew :cash-gateway-service:bootRun
./gradlew :payment-service:bootRun
```

---

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
hamster-world/
â”œâ”€â”€ common/                      # ê³µí†µ ëª¨ë“ˆ
â”‚   â””â”€â”€ src/main/kotlin/
â”‚       â””â”€â”€ com/hamsterworld/common/
â”‚           â”œâ”€â”€ domain/abs/      # AbsDomain, AbsDomainRoot
â”‚           â”œâ”€â”€ app/             # AppSearchQuery, AppPagedSearchQuery
â”‚           â””â”€â”€ web/             # Exception, Resolver, QuerydslExtension
â”‚
â”œâ”€â”€ ecommerce-service/
â”‚   â””â”€â”€ src/main/kotlin/.../ecommerce/
â”‚       â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ cart/           # Cart, CartItem
â”‚       â”‚   â”œâ”€â”€ order/          # Order, OrderItem (ì „í‘œìš©)
â”‚       â”‚   â””â”€â”€ user/           # User, Auth
â”‚       â””â”€â”€ app/
â”‚
â”œâ”€â”€ cash-gateway-service/       â­ Source of Truth
â”‚   â””â”€â”€ src/main/kotlin/.../cashgateway/
â”‚       â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ payment/        # Payment (ìµœì¢… ìŠ¹ì¸/ì·¨ì†Œ)
â”‚       â”‚   â””â”€â”€ paymentattempt/ # PaymentAttempt (PG ìš”ì²­/ì‘ë‹µ)
â”‚       â””â”€â”€ app/
â”‚
â”œâ”€â”€ payment-service/            â­ ì¬ê³  ê´€ë¦¬ (ë¦¬ì•¡í‹°ë¸Œ)
â”‚   â”œâ”€â”€ README.md               â† ìƒì„¸ ë¬¸ì„œ
â”‚   â””â”€â”€ src/main/kotlin/.../payment/
â”‚       â”œâ”€â”€ domain/
â”‚       â”‚   â”œâ”€â”€ product/        # Product (stock í¬í•¨)
â”‚       â”‚   â”œâ”€â”€ productrecord/  # ProductRecord (ì´ë²¤íŠ¸ ì†Œì‹±)
â”‚       â”‚   â””â”€â”€ ordersnapshot/  # OrderSnapshot (ê²°ì œ ì·¨ì†Œìš©)
â”‚       â””â”€â”€ consumer/           # Kafka Consumers
â”‚
â””â”€â”€ hamster-pg-service/         â­ PG ì‹œë®¬ë ˆì´í„°
    â”œâ”€â”€ README.md               â† ìƒì„¸ ë¬¸ì„œ
    â”œâ”€â”€ db/
    â”‚   â”œâ”€â”€ pg_mids.sql
    â”‚   â””â”€â”€ payments.sql
    â””â”€â”€ src/main/kotlin/.../hamsterpg/
        â”œâ”€â”€ domain/
        â”‚   â”œâ”€â”€ payment/        # Payment ë„ë©”ì¸
        â”‚   â”œâ”€â”€ pgmid/          # PgMid ë„ë©”ì¸
        â”‚   â””â”€â”€ notification/   # Webhook ì „ì†¡
        â”œâ”€â”€ infra/
        â””â”€â”€ app/
```

---

## ğŸ”¥ ë‹¤ìŒ ì„¸ì…˜ ì‘ì—… ì¸ìˆ˜ì¸ê³„

### âœ… ì™„ë£Œëœ ì‘ì—… (2026-02-02 ì„¸ì…˜ - ìµœì‹ )

#### **Public ID ë§ˆì´ê·¸ë ˆì´ì…˜ + QueryDSL Repository íŒ¨í„´ í†µì¼** âœ…

**1. Public ID ë§ˆì´ê·¸ë ˆì´ì…˜ (Response DTO ì •ë¦¬)**
- âœ… **ëª¨ë“  Response DTOì—ì„œ Internal PK ì œê±°**
  - Long Internal PK â†’ String Public IDë¡œ ë³€ê²½
  - í´ë¼ì´ì–¸íŠ¸ APIì—ì„œ Internal PK ë…¸ì¶œ ë°©ì§€

**ë³€ê²½ëœ íŒŒì¼:**
```
cash-gateway-service:
  - CashGatewayResponse.kt: attemptId (Long) â†’ attemptPublicId (String)
  - PaymentResponse.kt: paymentId, attemptId, originPaymentId (Long) â†’ Public IDs
  - PaymentController.kt: Public ID ì¡°íšŒ ë¡œì§ ì¶”ê°€

ecommerce-service:
  - MerchantResponse.kt: merchantId, userId (Long) â†’ Public IDs
  - MerchantController.kt: user.publicId ì „ë‹¬
  - OrderSearchRequest.kt: AppPagedSearchQuery ìƒì†ìœ¼ë¡œ ë¦¬íŒ©í† ë§
  - OrderController.kt: /list, /page ì—”ë“œí¬ì¸íŠ¸ ë¶„ë¦¬
  - OrderService.kt: LocalDate â†’ LocalDateTime ë³€í™˜ ì œê±° (QuerydslExtension.between í™œìš©)
  - OrderRepository.kt: baseQuery íŒ¨í„´ ì ìš©
```

**2. QueryDSL Repository íŒ¨í„´ í†µì¼ (ì „ì²´ ì„œë¹„ìŠ¤)**

**í•µì‹¬ íŒ¨í„´:**
```kotlin
// baseQuery() íŒ¨í„´
private fun baseQuery(request: SearchRequest): JPAQuery<Entity> {
    return jpaQueryFactory
        .selectFrom(qEntity)
        .where(*searchConditions(request).toTypedArray())
}

// searchConditions() ë¶„ë¦¬
private fun searchConditions(request: SearchRequest): List<BooleanExpression> {
    return listOfNotNull(
        QuerydslExtension.eqOrNull(qEntity.field, request.field),
        QuerydslExtension.between(qEntity.createdAt, request.from, request.to),
        QuerydslExtension.inOrNullSafe(qEntity.publicId, request.publicIds),
        QuerydslExtension.match(qEntity.name, request.name, request.match)
    )
}

// List ì¡°íšŒ
fun searchList(request: SearchRequest): List<Entity> {
    val query = baseQuery(request)
    return QuerydslExtension.applySorts(query, qEntity.createdAt, request.sort)
        .fetch()
}

// Page ì¡°íšŒ
fun searchPage(request: SearchRequest): Page<Entity> {
    val baseQuery = baseQuery(request)

    // Count query (deprecated fetchCount() ì œê±°)
    val total = jpaQueryFactory
        .select(qEntity.count())
        .from(qEntity)
        .where(*searchConditions(request).toTypedArray())
        .fetchOne() ?: 0L

    val pagedQuery = baseQuery
        .offset((request.page * request.size).toLong())
        .limit(request.size.toLong())

    val entities = QuerydslExtension.applySorts(pagedQuery, qEntity.createdAt, request.sort)
        .fetch()

    return PageImpl(entities, PageRequest.of(request.page, request.size), total)
}
```

**ë¦¬íŒ©í† ë§ëœ Repository ëª©ë¡:**

1. **OrderRepository (ecommerce-service)** âœ…
   - `baseUserOrderQuery()`, `baseVendorOrderQuery()` ì¶”ê°€
   - deprecated `fetchCount()` ì œê±° â†’ `select(count())` / `select(countDistinct())` ì‚¬ìš©
   - `searchUserOrderConditions()`, `searchVendorOrderConditions()` private ë©”ì„œë“œ ë¶„ë¦¬

2. **ProductRepository (ecommerce-service)** âœ…
   - `baseQuery()` íŒ¨í„´ ì ìš©
   - ë¹„íš¨ìœ¨ì ì¸ `.fetch().size` â†’ `select(count())` ê°œì„ 
   - `searchListConditions()` ì´ë¯¸ ë¶„ë¦¬ë˜ì–´ ìˆì—ˆìŒ

3. **ProductRepository (payment-service)** âœ…
   - deprecated `fetchCount()` ì œê±° â†’ `select(count())` ì‚¬ìš©
   - `baseQuery()` íŒ¨í„´ ì´ë¯¸ ì ìš©ë˜ì–´ ìˆì—ˆìŒ

4. **CartRepository (ecommerce-service)** âœ…
   - deprecated `fetchCount()` 2ê³³ ì œê±°
   - `baseQuery()` íŒ¨í„´ ì´ë¯¸ ì ìš©ë˜ì–´ ìˆì—ˆìŒ

5. **BoardRepository (ecommerce-service)** âœ…
   - `baseQuery()` íŒ¨í„´ ì ìš©
   - ë¹„íš¨ìœ¨ì ì¸ `.fetch().size` â†’ `select(count())` ê°œì„ 

6. **UserRepository (ecommerce-service)** âœ…
   - `baseQuery()`, `searchConditions()` íŒ¨í„´ ì ìš©
   - ì¤‘ë³µëœ ì¡°ê±´ ì½”ë“œ ì œê±°
   - ë¹„íš¨ìœ¨ì ì¸ `.fetch().size` â†’ `select(count())` ê°œì„ 

7. **PaymentRepository (hamster-pg-service)** âœ…
   - **ë©”ëª¨ë¦¬ í•„í„°ë§ â†’ QueryDSL ì¿¼ë¦¬ë¡œ ì™„ì „íˆ ì¬ì‘ì„±** ğŸ”¥
   - `baseQuery()`, `searchConditions()` íŒ¨í„´ ì ìš©
   - JPAQueryFactory ì˜ì¡´ì„± ì¶”ê°€
   - ê¸°ì¡´: `jpaRepository.findAll()` í›„ `filter { matchesSearchCriteria(it, request) }`
   - ê°œì„ : QueryDSLë¡œ DBì—ì„œ ì§ì ‘ í•„í„°ë§

8. **PgMidRepository (hamster-pg-service)** âœ…
   - **ë©”ëª¨ë¦¬ í•„í„°ë§ â†’ QueryDSL ì¿¼ë¦¬ë¡œ ì™„ì „íˆ ì¬ì‘ì„±** ğŸ”¥
   - `baseQuery()`, `searchConditions()` íŒ¨í„´ ì ìš©
   - JPAQueryFactory ì˜ì¡´ì„± ì¶”ê°€

9. **CommentRepository (ecommerce-service)** âœ…
   - ë¦¬íŒ©í† ë§ ë¶ˆí•„ìš” (í˜ì´ì§• ì—†ìŒ, ê°„ë‹¨í•œ ì¿¼ë¦¬)

10. **PaymentRepository (cash-gateway-service)** âœ…
    - ë¦¬íŒ©í† ë§ ë¶ˆí•„ìš” (ê°„ë‹¨í•œ CRUDë§Œ)

**ì£¼ìš” ê°œì„  ì‚¬í•­:**

âœ… **Deprecated ë©”ì„œë“œ ì œê±°**: `fetchCount()` â†’ `select(count())` ë˜ëŠ” `select(countDistinct())`
âœ… **baseQuery() íŒ¨í„´ í†µì¼**: ëª¨ë“  ê²€ìƒ‰ Repositoryì—ì„œ ì¼ê´€ëœ íŒ¨í„´ ì ìš©
âœ… **searchConditions() ë¶„ë¦¬**: ê²€ìƒ‰ ì¡°ê±´ì„ private ë©”ì„œë“œë¡œ ë¶„ë¦¬í•˜ì—¬ ì¬ì‚¬ìš©ì„± í–¥ìƒ
âœ… **ë©”ëª¨ë¦¬ í•„í„°ë§ ì œê±°**: hamster-pg-serviceì˜ 2ê°œ Repositoryì—ì„œ ë¹„íš¨ìœ¨ì ì¸ ë©”ëª¨ë¦¬ í•„í„°ë§ì„ QueryDSL ì¿¼ë¦¬ë¡œ ê°œì„  ğŸ”¥
âœ… **QuerydslExtension í™œìš©**: `between()`, `eqOrNull()`, `match()`, `applySorts()` ë“± ê³µí†µ ìœ í‹¸ë¦¬í‹° ë©”ì„œë“œ í™œìš©
âœ… **Count ì¿¼ë¦¬ ìµœì í™”**: ë¶ˆí•„ìš”í•œ `.fetch().size` ëŒ€ì‹  `select(count())` ì‚¬ìš©
âœ… **AppPagedSearchQuery ìƒì†**: ëª¨ë“  SearchRequestê°€ í‘œì¤€ í˜ì´ì§•/ì •ë ¬ íŒŒë¼ë¯¸í„° ìƒì†

**íŒ¨í„´ ì°¸ê³  ì†ŒìŠ¤:**
- `/Users/mac/IdeaProjects/payment-system/src/main/kotlin/com/payment/system/infra/cart/repository/CartRepository.kt`
- ëª¨ë“  Repositoryê°€ ìœ„ CartRepositoryì˜ `baseQuery()` + `searchListConditions()` íŒ¨í„´ì„ ë”°ë¦„

**ë¹Œë“œ ê²°ê³¼:**
```bash
./gradlew clean build -x test
# BUILD SUCCESSFUL - ëª¨ë“  ì„œë¹„ìŠ¤ ì»´íŒŒì¼ ì„±ê³µ
```

**ë‹¤ìŒ ì‘ì—…:**
- N+1 ë°©ì§€ íŒ¨í„´ í†µì¼ (Service ë ˆì´ì–´ì—ì„œ Batch ì¡°íšŒ í™œìš©)
- API ì‘ë‹µ DTOì—ì„œ ëˆ„ë½ëœ Public ID í•„ë“œ ì¶”ê°€ ê²€ì¦

---

### âœ… ì™„ë£Œëœ ì‘ì—… (2026-02-01 ì„¸ì…˜ - ìµœì‹  2)

#### **ì „ì²´ í”Œë¡œìš° ì™„ì„±: Order â†’ Stock â†’ Payment â†’ Webhook â†’ Order Update** âœ…

**í•µì‹¬ ì™„ì„± ì‚¬í•­:**
1. âœ… **orderNumber â†’ gatewayReferenceId ë¦¬ë„¤ì´ë° (ì—…ê³„ í‘œì¤€ ìš©ì–´)**
   - Cash Gateway ê³ ìœ  ê±°ë˜ ì‹ë³„ìë¡œ ëª…í™•í™”
   - Order.orderNumber (ê³ ê°ìš©) â‰  gatewayReferenceId (PG ë§¤ì¹­ìš©)

2. âœ… **Order ë„ë©”ì¸ í™•ì¥**
   - `orderNumber`: ê³ ê°ìš© ì£¼ë¬¸ë²ˆí˜¸ (ìë™ ìƒì„±: `ORD_20260201_A1B2C3D4`)
   - `gatewayReferenceId`: Payment ë§¤ì¹­ìš© (Payment ìŠ¹ì¸ í›„ ì±„ì›Œì§)

3. âœ… **Ecommerce Consumer ì™„ì„±**
   - `CashGatewayEventConsumer.kt` êµ¬í˜„
   - PaymentApprovedEvent â†’ Order.status = PAYMENT_APPROVED + gatewayReferenceId ì €ì¥
   - PaymentFailedEvent â†’ Order.status = PAYMENT_FAILED
   - PaymentCancelledEvent â†’ Order.status = CANCELED

**ì „ì²´ í”Œë¡œìš° (ì™„ì„±):**
```
[1] Cart â†’ Order ìƒì„±
    - orderNumber ìë™ ìƒì„±: "ORD_20260201123045_A1B2C3D4"
    - status: CREATED
    â†“ OrderCreatedEvent

[2] Payment Service: ì¬ê³  ê²€ì¦
    - ì„±ê³µ: OrderStockReservedEvent
    - ì‹¤íŒ¨: OrderStockValidationFailedEvent â†’ Order.status = PAYMENT_FAILED
    â†“

[3] Cash Gateway: PG ìš”ì²­
    - DomainConverter: OrderStockReservedEventDto â†’ PaymentApproveRequest
    - PaymentService.approve() í˜¸ì¶œ
    - PaymentAttempt ìƒì„± (UNKNOWN)
    - gatewayReferenceId ìë™ ìƒì„±: "CGW_DUMMY_MID_001_20260201..."
    - PG HTTP ìš”ì²­
    â†“

[4] Webhook ìˆ˜ì‹ 
    - gatewayReferenceIdë¡œ PaymentAttempt ì°¾ê¸°
    - UNKNOWN â†’ SUCCESS/FAILED CAS ì—…ë°ì´íŠ¸
    - Payment ìƒì„± (ì„±ê³µ ì‹œ)
    â†“ PaymentApprovedEvent / PaymentFailedEvent / PaymentCancelledEvent

[5] Ecommerce Consumer
    - PaymentApprovedEvent:
      * order.status = PAYMENT_APPROVED
      * order.gatewayReferenceId = event.gatewayReferenceId  // â† Payment ë§¤ì¹­
    - PaymentFailedEvent:
      * order.status = PAYMENT_FAILED
    - PaymentCancelledEvent:
      * order.status = CANCELED
```

**ID ì²´ê³„:**
```
Order (Ecommerce)
â”œâ”€ orderNumber: "ORD_20260201123045_A1B2C3D4"  // ê³ ê°ìš©
â”œâ”€ gatewayReferenceId: "CGW_DUMMY_MID_001_..."  // Payment ë§¤ì¹­
â””â”€ status: PAYMENT_APPROVED

PaymentAttempt (Cash Gateway)
â”œâ”€ gatewayReferenceId: "CGW_DUMMY_MID_001_..."  // Webhook ë§¤ì¹­ìš©
â”œâ”€ pgTransaction (tid): "PG12345678"
â””â”€ status: SUCCESS

Payment (Cash Gateway)
â”œâ”€ gatewayReferenceId: "CGW_DUMMY_MID_001_..."  // Order ë§¤ì¹­
â”œâ”€ pgTransaction: "PG12345678"
â””â”€ pgApprovalNo: "AUTH789"

// ë§¤ì¹­: Order.gatewayReferenceId = Payment.gatewayReferenceId
```

**íŠ¸ëœì­ì…˜ ì „íŒŒ ì •ì±… (EDA ìµœì í™”):**
```kotlin
// Kafka Consumer ì§„ì…ì 
@Transactional(propagation = Propagation.REQUIRES_NEW)
BaseKafkaConsumer.consumeEvent()

// ì´í›„ ëª¨ë“  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§
@Transactional(propagation = Propagation.MANDATORY)
- Consumer.handleEvent()
- Service.approve()
- Protocol.payment()
- CoreService.handleRequest()

// ì¥ì : PG ì‹¤íŒ¨ ì‹œ ì „ì²´ ë¡¤ë°± â†’ Kafka ì¬ì‹œë„ â†’ ë©±ë“±ì„± ë³´ì¥
```

**êµ¬í˜„ íŒŒì¼ (ìµœì¢…):**
```
ecommerce-service/
â”œâ”€â”€ domain/order/
â”‚   â”œâ”€â”€ model/Order.kt                    # orderNumber, gatewayReferenceId ì¶”ê°€
â”‚   â””â”€â”€ repository/OrderRepository.kt     # generateOrderNumber()
â”œâ”€â”€ consumer/
â”‚   â”œâ”€â”€ CashGatewayEventConsumer.kt       # ğŸ†• Cash Gateway ì´ë²¤íŠ¸ ì²˜ë¦¬
â”‚   â””â”€â”€ CashGatewayEventDtos.kt           # ğŸ†• DTO (3ì¢…)
â””â”€â”€ db/orders.sql                          # order_number, gateway_reference_id ì»¬ëŸ¼

cash-gateway-service/
â”œâ”€â”€ domain/
â”‚   â”œâ”€â”€ paymentattempt/model/PaymentAttempt.kt  # gatewayReferenceId
â”‚   â”œâ”€â”€ payment/model/Payment.kt                # gatewayReferenceId (NOT NULL)
â”‚   â””â”€â”€ payment/event/
â”‚       â”œâ”€â”€ PaymentApprovedEvent.kt       # gatewayReferenceId í•„ë“œ
â”‚       â”œâ”€â”€ PaymentFailedEvent.kt
â”‚       â””â”€â”€ PaymentCancelledEvent.kt
â”œâ”€â”€ external/paymentgateway/abs/
â”‚   â”œâ”€â”€ PaymentGatewayProvider.kt         # extractGatewayReferenceId()
â”‚   â””â”€â”€ PaymentGatewayCoreService.kt      # generateGatewayReferenceId()
â””â”€â”€ db/
    â”œâ”€â”€ payment_attempts.sql              # gateway_reference_id ì»¬ëŸ¼
    â””â”€â”€ payments.sql                      # gateway_reference_id ì»¬ëŸ¼
```

**ë‹¤ìŒ ì‘ì—…:**
1. Payment Service Consumer (ì¬ê³  ë³µì› on PaymentCancelledEvent)
2. Kafka Producer ì„¤ì •
3. í†µí•© í…ŒìŠ¤íŠ¸ (ì „ì²´ í”Œë¡œìš°)

---

### âœ… ì™„ë£Œëœ ì‘ì—… (2026-02-01 ì„¸ì…˜ - ìµœì‹  1)

#### **Cash Gateway: Domain Event Pattern + Webhook ì „ìš© ì •ì±… ì™„ë£Œ** âœ…

**í•µì‹¬ ì•„í‚¤í…ì²˜ ê²°ì •:**
1. âœ… **PaymentëŠ” ì„±ê³µ/ì·¨ì†Œë§Œ ê¸°ë¡, ì‹¤íŒ¨ëŠ” PaymentAttemptë§Œ**
   - Payment = ì„±ê³µí•œ ê±°ë˜ë§Œ (APPROVED, CANCELLED)
   - PaymentAttempt = ëª¨ë“  ì‹œë„ ê¸°ë¡ (UNKNOWN, SUCCESS, FAILED, CANCELLED)
   - ì‹¤íŒ¨ ì‹œ Payment ìƒì„± ì•ˆ í•¨ âŒ

2. âœ… **Domain Event Pattern ì ìš©**
   - Payment ì—”í‹°í‹°ê°€ ìì‹ ì˜ ì´ë²¤íŠ¸ ê´€ë¦¬ (`onCreate()`, `onCancel()`)
   - CoreServiceëŠ” ì‹¤íŒ¨ë§Œ ì§ì ‘ ì´ë²¤íŠ¸ ë°œí–‰
   - Spring Dataì˜ `AbstractAggregateRoot` í™œìš©

3. âœ… **Webhook ì „ìš© ì •ì±…**
   - PG ì‘ë‹µ ì„±ê³µí•´ë„ Payment ìƒì„± ì•ˆ í•¨ (null ë°˜í™˜)
   - ëª¨ë“  PaymentëŠ” Webhookì—ì„œë§Œ ìƒì„±
   - ë™ê¸°/ë¹„ë™ê¸° ê´€ê³„ì—†ì´ ì¼ê´€ëœ í”Œë¡œìš°

**êµ¬í˜„ ì™„ë£Œ:**
1. âœ… **CashGatewayDomainEvent ê¸°ë³¸ í´ë˜ìŠ¤**
   - `BaseDomainEvent` ìƒì†
   - Kafka í† í”½: `cash-gateway-events`
   ```kotlin
   abstract class CashGatewayDomainEvent(
       aggregateId: String,
       eventId: String = UUID.randomUUID().toString(),
       traceId: String? = null,
       occurredAt: LocalDateTime = LocalDateTime.now()
   ) : BaseDomainEvent(topic = "cash-gateway-events")
   ```

2. âœ… **Payment ì´ë²¤íŠ¸ ì¬ì„¤ê³„**
   - `PaymentApprovedEvent`: Payment í•„ë“œ í¬í•¨ (paymentId, orderId, amount, ...)
   - `PaymentCancelledEvent`: originPaymentId í¬í•¨
   - `PaymentFailedEvent`: PaymentAttempt í•„ë“œë§Œ (Payment ì—†ìŒ!)
   - `companion object fun from()` íŒ©í† ë¦¬ ë©”ì„œë“œ

3. âœ… **Payment ì—”í‹°í‹° ì´ë²¤íŠ¸ ë“±ë¡**
   ```kotlin
   fun onCreate(): Payment {
       registerEvent(PaymentApprovedEvent.from(this))
       return this
   }

   fun onCancel(originPaymentId: Long): Payment {
       registerEvent(PaymentCancelledEvent.from(this, originPaymentId))
       return this
   }
   ```

4. âœ… **PaymentGatewayCoreService ìˆ˜ì •**
   ```kotlin
   // ìŠ¹ì¸
   private fun createApprovePayment(...): Payment {
       val payment = Payment(...).onCreate()  // ì´ë²¤íŠ¸ ë“±ë¡
       return paymentRepository.save(payment)  // save ì‹œ ìë™ ë°œí–‰
   }

   // ì·¨ì†Œ
   private fun createCancelPayment(...): Payment {
       val payment = Payment(...).onCancel(originId)
       return paymentRepository.save(payment)
   }

   // ì‹¤íŒ¨ (Payment ì—†ìŒ)
   fun handleResponseFailure(event: PaymentAttempt) {
       // ...
       eventPublisher.publishEvent(PaymentFailedEvent.from(event, reason))
   }
   ```

5. âœ… **Webhook ì „ìš© ì •ì±… ì ìš©**
   ```kotlin
   // PaymentGatewayClientProtocolCore.payment()
   override fun payment(paymentCtx: ApprovePaymentCtx): Payment? {
       // PG ìš”ì²­
       val response = pgRestTemplate.exchange(...)

       if (!provider.isSuccess(response)) {
           throw CustomRuntimeException(...)
       }

       // ì„±ê³µí•´ë„ Payment ìƒì„± ì•ˆ í•¨!
       return null  // Webhookì—ì„œë§Œ ìƒì„±
   }
   ```

6. âœ… **orderNumber ìë™ ìƒì„±**
   ```kotlin
   // PaymentGatewayCoreService.handleRequest()
   if (attempt.orderNumber == null) {
       attempt.orderNumber = generateOrderNumber(
           provider, mid, LocalDateTime.now()
       )
   }
   // í˜•ì‹: CGW_{PROVIDER}_{MID}_{TIMESTAMP}_{RANDOM}
   // ì˜ˆ: CGW_DUMMY_CGW_MID_001_20260201123045_a1b2c3d4
   ```

7. âœ… **Webhook ë‚´ë¶€/ì™¸ë¶€ ê±°ë˜ êµ¬ë¶„**
   ```kotlin
   override fun handleWebhook(rawPayload: String): Payment? {
       val orderNumber = provider.extractOrderNumber(response)
       val mid = provider.extractMid(response) ?: provider.getMid()

       if (orderNumber != null) {
           // [ë‚´ë¶€ ê±°ë˜] orderNumber ì¡´ì¬
           val attempt = findByProviderAndOrderNumberAndMid(
               provider, orderNumber, mid
           ) ?: throw CustomRuntimeException(...)
           return handleInternalWebhook(attempt, response, rawPayload)
       } else {
           // [ì™¸ë¶€ ê±°ë˜] orderNumber ì—†ìŒ + tid ìˆìŒ
           val tid = response.getPgTransaction()
           val duplicateCheck = findAttemptByTid(tid)
           if (duplicateCheck != null) return null
           return handleExternalWebhook(response, rawPayload, tid, mid)
       }
   }
   ```

8. âœ… **DB ìŠ¤í‚¤ë§ˆ ì—…ë°ì´íŠ¸**
   ```sql
   -- payment_attempts
   is_external BOOLEAN GENERATED ALWAYS AS (order_id IS NULL) STORED,
   origin_source VARCHAR(100) NOT NULL,

   -- payments
   mid VARCHAR(100) NOT NULL,
   origin_source VARCHAR(100) NOT NULL
   ```

**ì´ë²¤íŠ¸ ë°œí–‰ íë¦„:**
```
[ì„±ê³µ ì¼€ì´ìŠ¤]
PaymentAttempt (SUCCESS)
  â†’ createApprovePayment()
    â†’ Payment(...).onCreate()  // ì´ë²¤íŠ¸ ë“±ë¡
      â†’ paymentRepository.save()
        â†’ @AfterDomainEventPublication
          â†’ Kafka: cash-gateway-events
            â†’ PaymentApprovedEvent

[ì·¨ì†Œ ì¼€ì´ìŠ¤]
PaymentAttempt (CANCELLED)
  â†’ createCancelPayment()
    â†’ Payment(...).onCancel(originId)
      â†’ paymentRepository.save()
        â†’ Kafka: PaymentCancelledEvent

[ì‹¤íŒ¨ ì¼€ì´ìŠ¤]
PaymentAttempt (FAILED)
  â†’ handleResponseFailure()
    â†’ eventPublisher.publishEvent(PaymentFailedEvent)
      â†’ Kafka: PaymentFailedEvent
```

**ë‹¤ìŒ ë‹¨ê³„:**
1. Kafka Producer ì„¤ì •
2. Ecommerce-Service Consumer êµ¬í˜„ (Order ìƒíƒœ ë³€ê²½)
3. Payment-Service Consumer êµ¬í˜„ (ì¬ê³  ë³µì›)

---

## ì°¸ê³  ë¬¸ì„œ

- **Ecommerce Service ìƒì„¸:** [ecommerce-service/README.md](./ecommerce-service/README.md)
- **Cash Gateway Service ìƒì„¸:** [cash-gateway-service/README.md](./cash-gateway-service/README.md)
- **Payment Service ìƒì„¸:** [payment-service/README.md](./payment-service/README.md)
- **Hamster PG Service ìƒì„¸:** [hamster-pg-service/README.md](./hamster-pg-service/README.md)
- **Docker Compose:** `docker-compose.yml`
- **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ:** ê° ì„œë¹„ìŠ¤ì˜ `db/` ë””ë ‰í† ë¦¬
- **ì›ë³¸ í”„ë¡œì íŠ¸ (ì°¸ê³ ìš©):** `/Users/mac/IdeaProjects/payment-system`

---

## ë¬¸ì˜

í”„ë¡œì íŠ¸ ê´€ë ¨ ë¬¸ì˜ì‚¬í•­ì€ ì´ìŠˆë¡œ ë“±ë¡í•´ì£¼ì„¸ìš”.
