name: Terraform Apply

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Total workflow duration including destroy (minutes)'
        required: true
        default: '20'
        type: string
      cooldown:
        description: 'Cooldown buffer for destroy phase (minutes)'
        required: true
        default: '5'
        type: string

defaults:
  run:
    working-directory: terraform

env:
  TF_VAR_aws_access_key: ${{ secrets.AWS_ACCESS_KEY }}
  TF_VAR_aws_secret_key: ${{ secrets.AWS_SECRET_KEY }}
  TF_VAR_db_root_password: ${{ secrets.DB_ROOT_PASSWORD }}
  TF_VAR_keycloak_admin_password: ${{ secrets.KEYCLOAK_ADMIN_PASSWORD }}
  TF_VAR_mongo_password: ${{ secrets.MONGO_PASSWORD }}
  # INFRA_STATUS push용
  GH_API: https://api.github.com
  GH_REPO: ${{ github.repository }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write          # Repository Variables API (INFRA_STATUS) 업데이트
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.0
          # wrapper 기본값(true)이면 terraform output -json 결과에 메타데이터가 섞여
          # jq 파싱이 깨진다. INFRA_STATUS push step에서 IP 추출용으로 필요.
          terraform_wrapper: false

      - name: Terraform Init
        run: terraform init

      - name: Terraform Apply
        run: terraform apply -auto-approve -input=false

      - name: Push instance status (apply complete)
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GH_DEPLOY_TOKEN }}
        run: |
          cd $GITHUB_WORKSPACE/terraform

          # terraform output에서 인스턴스별 IP 추출
          INSTANCES_JSON=$(terraform output -json instances 2>/dev/null || echo '{}')

          # 인스턴스 ID 목록과 terraform 리소스명 매핑
          declare -A TF_NAMES=(
            [hamster-db]=db
            [hamster-auth]=auth
            [hamster-kafka]=kafka
            [hamster-commerce]=commerce
            [hamster-billing]=billing
            [hamster-payment]=payment
            [hamster-support]=support
            [hamster-front]=front
          )

          # INFRA_STATUS JSON 구성
          STATUS_INSTANCES="{"
          FIRST=true
          for INST_ID in "${!TF_NAMES[@]}"; do
            TF_NAME="${TF_NAMES[$INST_ID]}"
            IP=$(echo "$INSTANCES_JSON" | jq -r ".\"${INST_ID}\".ip // empty" 2>/dev/null || echo "")

            if [ "$FIRST" = true ]; then FIRST=false; else STATUS_INSTANCES+=","; fi
            STATUS_INSTANCES+="\"${INST_ID}\":{\"status\":\"running\""
            if [ -n "$IP" ]; then
              STATUS_INSTANCES+=",\"ip\":\"${IP}\""
            fi
            STATUS_INSTANCES+="}"
          done
          STATUS_INSTANCES+="}"

          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          PAYLOAD=$(jq -n --arg inst "$STATUS_INSTANCES" --arg ts "$TIMESTAMP" \
            '{phase: "running", instances: ($inst | fromjson), updatedAt: $ts}')

          # INFRA_STATUS variable 업데이트 (PATCH)
          ESCAPED=$(echo "$PAYLOAD" | jq -Rs '.')
          curl -sf -X PATCH \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"value\": ${ESCAPED}}" \
            "${GH_API}/repos/${GH_REPO}/actions/variables/INFRA_STATUS" \
            || echo "::warning::Failed to update INFRA_STATUS variable"

          echo "INFRA_STATUS updated: phase=running"

      - name: Wait for active runtime
        run: |
          ACTIVE=$(( ${{ inputs.duration }} - ${{ inputs.cooldown }} ))
          echo "Session started. Active runtime: ${ACTIVE} minutes (total ${{ inputs.duration }}, cooldown ${{ inputs.cooldown }})"
          sleep $(( ACTIVE * 60 ))

      - name: Push instance status (destroying)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_DEPLOY_TOKEN }}
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          PAYLOAD=$(jq -n --arg ts "$TIMESTAMP" '{
            phase: "destroying",
            instances: {
              "hamster-db":       {"status":"destroying"},
              "hamster-auth":     {"status":"destroying"},
              "hamster-kafka":    {"status":"destroying"},
              "hamster-commerce": {"status":"destroying"},
              "hamster-billing":  {"status":"destroying"},
              "hamster-payment":  {"status":"destroying"},
              "hamster-support":  {"status":"destroying"},
              "hamster-front":    {"status":"destroying"}
            },
            updatedAt: $ts
          }')

          ESCAPED=$(echo "$PAYLOAD" | jq -Rs '.')
          curl -sf -X PATCH \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"value\": ${ESCAPED}}" \
            "${GH_API}/repos/${GH_REPO}/actions/variables/INFRA_STATUS" \
            || echo "::warning::Failed to update INFRA_STATUS variable"

          echo "INFRA_STATUS updated: phase=destroying"

      - name: Force unlock state
        if: cancelled()
        run: |
          # terraform은 state 파일 동시 수정 방지를 위해 두 가지 lock을 건다:
          #   1. .terraform.tfstate.lock.info 파일 (lock 메타데이터)
          #   2. terraform.tfstate 파일 자체에 OS 레벨 flock (파일 잠금)
          #
          # cancel로 Apply가 중단되면:
          #   - SIGINT → terraform graceful shutdown 시도 → 프로세스 종료
          #   - 하지만 flock은 프로세스가 완전히 종료되어야 해제됨
          #   - 다음 step이 즉시 시작되면 flock이 아직 남아있을 수 있음
          #
          # 해결: lock 파일 삭제 + terraform 프로세스 완전 종료 대기
          rm -f .terraform.tfstate.lock.info 2>/dev/null || true
          # terraform 프로세스가 완전히 종료될 때까지 대기 (flock 해제)
          sleep 5

      - name: Terraform Destroy
        if: always()
        run: |
          # always: 정상 완료, 실패, cancel 모든 경우에 실행
          # state에 기록된 리소스만 파괴 (13개 중 4개만 생성됐으면 4개만 destroy)
          # -lock=false: cancel 후 OS flock이 남아있을 경우를 대비한 안전장치
          terraform destroy -auto-approve -input=false -lock=false

      - name: Push instance status (idle)
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GH_DEPLOY_TOKEN }}
        run: |
          TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          PAYLOAD=$(jq -n --arg ts "$TIMESTAMP" '{
            phase: "idle",
            instances: {
              "hamster-db":       {"status":"idle"},
              "hamster-auth":     {"status":"idle"},
              "hamster-kafka":    {"status":"idle"},
              "hamster-commerce": {"status":"idle"},
              "hamster-billing":  {"status":"idle"},
              "hamster-payment":  {"status":"idle"},
              "hamster-support":  {"status":"idle"},
              "hamster-front":    {"status":"idle"}
            },
            updatedAt: $ts
          }')

          ESCAPED=$(echo "$PAYLOAD" | jq -Rs '.')
          curl -sf -X PATCH \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "{\"value\": ${ESCAPED}}" \
            "${GH_API}/repos/${GH_REPO}/actions/variables/INFRA_STATUS" \
            || echo "::warning::Failed to update INFRA_STATUS variable"

          echo "INFRA_STATUS updated: phase=idle"
