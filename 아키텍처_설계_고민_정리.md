# ì•„í‚¤í…ì²˜ ì„¤ê³„ ê³ ë¯¼: Payment ì—”í‹°í‹°ì˜ ìœ„ì¹˜ì™€ ì§„ì‹¤ì˜ ì›ì²œ

> **ì‘ì„±ì¼**: 2026-02-06
> **ëª©ì **: Payment ì—”í‹°í‹°ë¥¼ ì–´ëŠ ì„œë¹„ìŠ¤ì— ë‘˜ ê²ƒì¸ê°€? Cash Gateway vs Payment Service

---

## ğŸ“‹ ëª©ì°¨
1. [ë°°ê²½](#ë°°ê²½)
2. [í˜„ì¬ êµ¬ì¡°](#í˜„ì¬-êµ¬ì¡°)
3. [í•µì‹¬ ì§ˆë¬¸](#í•µì‹¬-ì§ˆë¬¸)
4. [ë‘ ê°€ì§€ ì›ìì„± ìš”êµ¬ì‚¬í•­](#ë‘-ê°€ì§€-ì›ìì„±-ìš”êµ¬ì‚¬í•­)
5. [ì˜µì…˜ ë¹„êµ](#ì˜µì…˜-ë¹„êµ)
6. [ê²°ë¡  ë° ì¶”ì²œ](#ê²°ë¡ -ë°-ì¶”ì²œ)

---

## ë°°ê²½

### ì´ˆê¸° ê¸°íš ì˜ë„

**Hamster World = PG ì¤‘ê°œ í”Œë«í¼**

```
ë²¤ë” ì‡¼í•‘ëª° (ecommerce-service)
    â†“
    â”œâ”€ ê²½ë¡œA: ì§ì ‘ PG ê³„ì•½ (ë‚®ì€ ìˆ˜ìˆ˜ë£Œ)
    â””â”€ ê²½ë¡œB: í–„ìŠ¤í„°ì›”ë“œ ì¤‘ê°œ (ë†’ì€ ìˆ˜ìˆ˜ë£Œ)
    â†“
Cash Gateway Service (ê²°ì œ ë°©í™”ë²½)
    - ëª¨ë“  ê²°ì œ ì´ë²¤íŠ¸ì˜ ì§‘í•©ì 
    - PG í†µì‹  ë‹´ë‹¹
    - ë³µì¡í•œ ê²°ì œ ë¡œì§ ì²˜ë¦¬
    â†“ Kafka (ë‚´ë¶€ë§Œ)
Payment Service (ì •ì‚°/ì¬ê³ /ê¶Œí•œ)
    - ì¬ê³  ê´€ë¦¬ (ì´ë²¤íŠ¸ ì†Œì‹±)
    - ì •ì‚° ê³„ì‚°
    - ì™„ì „ Private (HTTP API ì—†ìŒ)
```

**í•µì‹¬ ì² í•™:**
> "í•µì‹¬ì€ ì‚¬ì‹¤ í˜ì´ë¨¼íŠ¸ ì‹œìŠ¤í…œì´ ì œì¼í•µì‹¬ì´ì•¼. ë‹¤ë§Œ ì´ëŸ° ê¸°ëŠ¥ ì €ëŸ°ê¸°ëŠ¥ ì™¸ë¶€ ë…¸ì¶œì‹œí‚¤ë©´ ê± ë”ëŸ¬ì›Œì ¸.
> ê·¸ë˜ì„œ ê·¸ ë°©í™”ë²½ì„ ìºì‹œê²Œì´íŠ¸ì›¨ì´ ì• ë‹¨ì— ë‘”ê±°ì•¼."

---

## í˜„ì¬ êµ¬ì¡°

### ì„œë¹„ìŠ¤ë³„ ì—­í• 

| ì„œë¹„ìŠ¤ | ì—­í•  | í†µì‹  ë°©ì‹ | DB |
|--------|------|-----------|-----|
| **ecommerce-service** | ë²¤ë” ì‡¼í•‘ëª° (Order, Cart, Product ê´€ë¦¬) | HTTP + Webhook | ecommerce_db |
| **cash-gateway-service** | ê²°ì œ ë°©í™”ë²½ + PG í†µì‹  | HTTP API (ê³µê°œ) + Kafka (ë‚´ë¶€) | cash_gateway_db |
| **payment-service** | ì¬ê³  ê´€ë¦¬ + ì •ì‚° | Kafka Consumerë§Œ (Private) | payment_db |
| **hamster-pg-service** | PG ì‹œë®¬ë ˆì´í„° | HTTP + Webhook | hamster_pg_db |

### í˜„ì¬ ë°ì´í„° ëª¨ë¸

#### Cash Gateway Service (cash_gateway_db)
```kotlin
// PaymentProcess: PG ìš”ì²­/ì‘ë‹µ ìƒíƒœ ì¶”ì 
@Entity
class PaymentProcess(
    var gatewayReferenceId: String,  // ê³ ìœ  ì‹ë³„ì
    var orderPublicId: String?,
    var status: PaymentProcessStatus,  // UNKNOWN, PENDING, SUCCESS, FAILED
    var pgTransaction: String?,
    var amount: BigDecimal
)

// Payment: í™•ì •ëœ ê±°ë˜ ê¸°ë¡ (í˜„ì¬ ì—¬ê¸° ìœ„ì¹˜)
@Entity
class Payment(
    var processId: Long,  // PaymentProcess FK
    var orderPublicId: String?,
    var amount: BigDecimal,
    var status: PaymentStatus,  // APPROVED, CANCELLED
    var pgTransaction: String?
)
```

#### Payment Service (payment_db)
```kotlin
// Product: ì¬ê³  ê´€ë¦¬
@Entity
class Product(
    var ecommerceProductId: String?,
    var stock: Int,
    var isSoldOut: Boolean
)

// ProductRecord: ì¬ê³  ë³€ê²½ ì´ë ¥ (Event Sourcing)
@Entity
class ProductRecord(
    var productId: Long,
    var stock: Int,  // Delta ê°’
    var reason: String
)

// OrderSnapshot: ì£¼ë¬¸ ìŠ¤ëƒ…ìƒ· (ê²°ì œ ì·¨ì†Œ ì‹œ ë³µì›ìš©)
@Entity
class OrderSnapshot(
    var orderId: Long,
    var orderNumber: String,
    var totalPrice: BigDecimal
)

// Payment ì—”í‹°í‹° ì—†ìŒ! â­
```

---

## í•µì‹¬ ì§ˆë¬¸

### ìµœì´ˆ ì§ˆë¬¸ (ì¶œë°œì )
> "í˜ì´ë¨¼íŠ¸ ì„œë¹„ìŠ¤ê°€ ì§„ì‹¤ì˜ ì›ì²œìœ¼ë¡œ í–‰í•˜ë ¤ê³  í–ˆì–´. ê·¼ë° ì§€ê¸ˆì€ PaymentProcess ê¸°ë°˜ìœ¼ë¡œ Paymentê°€ ìƒì„±ë˜ì–ì•„.
> ì´ê±´ ê·¸ëƒ¥ ìºì‹œê²Œì´íŠ¸ì›¨ì´ê°€ ê°€ì§€ê³  ìˆì–´ì•¼ê² ì§€?
> ê·¼ë° ê·¸ëŸ¼ ì§„ì‹¤ì˜ ì›ì²œì´... ì´ Paymentë¥¼ Payment ì„œë¹„ìŠ¤ê°€ ë³µì œí•´ì•¼ í•˜ëŠ” ê±´ê°€?"

### ì§„í™”ëœ ì§ˆë¬¸
> "ê²°êµ­ ë­˜ ì–´ë–»ê²Œ í•˜ëƒì— ë”°ë¼ ë‹¤ë¥¸ ê±°ë„¤.
> í•œí¸ìœ¼ë¡  **PaymentProcessê°€ ë³€í•˜ë©´ Paymentê°€ ìƒì„±ë˜ì–´ì•¼ í•˜ëŠ” ì›ìì„±**ê³¼
> **Paymentê°€ ìƒì„± ì‹œ Stockì´ ë³€í•´ì•¼ í•˜ëŠ” ì›ìì„±**.
> ì „ìë„ ë§ê³  í›„ìë„ ë§ëŠ” ê±°ì§€?"

---

## ë‘ ê°€ì§€ ì›ìì„± ìš”êµ¬ì‚¬í•­

### ì›ìì„± A: PaymentProcess â†” Payment

```
PG ì›¹í›… ìˆ˜ì‹  ì‹œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @Transactional                      â”‚
â”‚  1. PaymentProcess: PENDING â†’ SUCCESS â”‚
â”‚  2. Payment ìƒì„±                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë§Œì•½ ë¶„ë¦¬ë˜ë©´?**
- PaymentProcessëŠ” SUCCESSì¸ë° Payment ì—†ìŒ ğŸ’¥
- ë°ì´í„° ë¶ˆì¼ì¹˜ ë°œìƒ

**ì¤‘ìš”ë„:** ë‚®ìŒ âš ï¸
**ì´ìœ :** PaymentProcessëŠ” ìƒíƒœ ì¶”ì ìš© ë©”íƒ€ë°ì´í„°. Eventually Consistentë¡œ í•´ê²° ê°€ëŠ¥.

---

### ì›ìì„± B: Payment â†” Stock â†” OrderSnapshot

```
ê²°ì œ ìŠ¹ì¸ ì‹œ:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ @Transactional                      â”‚
â”‚  1. Payment ìƒì„±                    â”‚
â”‚  2. Stock ì°¨ê° í™•ì •                 â”‚
â”‚  3. OrderSnapshot ì—°ê²°              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë§Œì•½ ë¶„ë¦¬ë˜ë©´?**
- PaymentëŠ” ìˆëŠ”ë° ì¬ê³  ì°¨ê° ì•ˆ ë¨ ğŸ’¥
- ì¬ê³ ë§Œ ì°¨ê°ë˜ê³  Payment ì—†ìŒ ğŸ’¥
- ì •ì‚°/ë³µì› ë¶ˆê°€ëŠ¥

**ì¤‘ìš”ë„:** ë†’ìŒ â­â­â­
**ì´ìœ :** ì£¼ë¬¸ ì´í–‰ì— í•„ìˆ˜ì ì¸ ë°ì´í„°. ì›ìì„± í•„ìˆ˜.

---

## í˜„ì¬ í”Œë¡œìš° (ì„ ì°¨ê° ì „ëµ)

```
[1] ì£¼ë¬¸ ìƒì„± (Ecommerce)
    OrderCreatedEvent ë°œí–‰

[2] ì¬ê³  ì„ ì°¨ê° (Payment Service) â­ ì´ë¯¸ í™•ì •!
    @Transactional
    - Product.stock ì°¨ê°
    - ProductRecord ìƒì„± (Event Sourcing)
    - OrderSnapshot ìƒì„±
    â†’ OrderStockReservedEvent ë°œí–‰

[3] PG ìš”ì²­ (Cash Gateway)
    - PaymentProcess: UNKNOWN â†’ PENDING
    - hamster-pgë¡œ HTTP ìš”ì²­

[4] ì›¹í›… ìˆ˜ì‹  (Cash Gateway)
    - PaymentProcess: PENDING â†’ SUCCESS
    - Payment ìƒì„± â† í˜„ì¬ ì—¬ê¸°ì„œ ìƒì„±
    â†’ PaymentApprovedEvent ë°œí–‰

[5] ì¬ê³  í™•ì •? (Payment Service)
    - í˜„ì¬ëŠ” ë³„ë„ ì²˜ë¦¬ ì—†ìŒ
```

**ì„ ì°¨ê° ì „ëµ ì´ìœ :**
- ì´ˆê³¼íŒë§¤ ë°©ì§€ (Over-selling prevention)
- PG ìš”ì²­ë§Œ í•˜ê³  ëŠìœ¼ë©´ ë™ì‹œ ì£¼ë¬¸ ì‹œ ê°™ì€ ì¬ê³  ì—¬ëŸ¬ ë²ˆ íŒë§¤ë¨
- í í´ë§(1ì´ˆ ê°„ê²©)ë„ ë™ì‹œì„± ë¬¸ì œ í•´ê²° ì•ˆ ë¨

**ì´ê±´ ì ˆëŒ€ ë³€ê²½í•˜ë©´ ì•ˆ ë¨!** âœ…

---

## ì˜µì…˜ ë¹„êµ

### ì˜µì…˜ A: í˜„ì¬ êµ¬ì¡° ìœ ì§€ (Paymentë¥¼ Cash Gatewayì—)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cash Gateway (cash_gateway_db)      â”‚
â”‚                                     â”‚
â”‚ @Transactional                      â”‚
â”‚  - PaymentProcess â†’ SUCCESS         â”‚
â”‚  - Payment ìƒì„±  â† ì›ìì„± A ë³´ì¥    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Kafka: PaymentApprovedEvent
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment Service (payment_db)        â”‚
â”‚                                     â”‚
â”‚ - Payment ì—”í‹°í‹° ì—†ìŒ â­             â”‚
â”‚ - ì´ë²¤íŠ¸ë§Œ ë°›ì•„ì„œ ë¦¬ì•¡í‹°ë¸Œ ë°˜ì‘      â”‚
â”‚ - Stock, OrderSnapshot, ProductRecordâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ì¥ì :**
- âœ… ì›ìì„± A ë³´ì¥ (PaymentProcess + Payment ê°™ì€ íŠ¸ëœì­ì…˜)
- âœ… Cash Gateway = "Payment ì§„ì‹¤ì˜ ì›ì²œ"
- âœ… Payment Service = Payment ëª°ë¼ë„ ë¨

**ë‹¨ì :**
- âŒ ì›ìì„± B ê¹¨ì§ (Paymentì™€ Stockì´ ë‹¤ë¥¸ DB)
- âŒ Payment ìƒì„±ëëŠ”ë° ì¬ê³  ì°¨ê° ì‹¤íŒ¨ ê°€ëŠ¥
- âŒ ì¬ê³  ì°¨ê°ëëŠ”ë° Payment ìƒì„± ì‹¤íŒ¨ ê°€ëŠ¥
- âŒ ë³´ìƒ íŠ¸ëœì­ì…˜ ë³µì¡

**ì§„ì‹¤ì˜ ì›ì²œ:**
- Cash Gateway: Payment
- Payment Service: Stock

---

### ì˜µì…˜ B: Paymentë¥¼ Payment Serviceë¡œ ì´ë™ â­ ì¶”ì²œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cash Gateway (cash_gateway_db)      â”‚
â”‚                                     â”‚
â”‚ - PaymentProcessë§Œ (ìƒíƒœ ì¶”ì ìš©)    â”‚
â”‚ - Payment ìƒì„± ì•ˆ í•¨ â­              â”‚
â”‚ - ì›¹í›… â†’ Kafka ë°œí–‰ë§Œ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Kafka: PaymentApprovedEvent
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment Service (payment_db)        â”‚
â”‚                                     â”‚
â”‚ @Transactional                      â”‚
â”‚  - Payment ìƒì„±  â† ì—¬ê¸°ì„œ!          â”‚
â”‚  - Stock ì´ë¯¸ ì°¨ê°ë¨ (ì„ ì°¨ê°)        â”‚
â”‚  - OrderSnapshot ì—°ê²°               â”‚
â”‚  â†’ ì›ìì„± B ë³´ì¥ â­                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**ë³€ê²½ëœ í”Œë¡œìš°:**
```
[1] ì£¼ë¬¸ ìƒì„±
[2] ì¬ê³  ì„ ì°¨ê° (Payment Service)
[3] PG ìš”ì²­ (Cash Gateway)
[4] ì›¹í›… ìˆ˜ì‹  (Cash Gateway)
    - PaymentProcess â†’ SUCCESS
    â†’ PaymentApprovedEvent ë°œí–‰ (Payment ìƒì„± ì•ˆ í•¨!)

[5] Payment ìƒì„± (Payment Service) â­ ìƒˆë¡œ ì¶”ê°€
    @Transactional
    - Payment ìƒì„±
    - ê¸°ì¡´ OrderSnapshotê³¼ ì—°ê²°
    - ProductRecordëŠ” ì´ë¯¸ ì¡´ì¬ (ì„ ì°¨ê° ë•Œ ìƒì„±)
```

**ì¥ì :**
- âœ… ì›ìì„± B ë³´ì¥ (Payment + Stock + OrderSnapshot ê°™ì€ íŠ¸ëœì­ì…˜)
- âœ… ë„ë©”ì¸ ì‘ì§‘ì„±: ì£¼ë¬¸ ì´í–‰ ë°ì´í„° ëª¨ë‘ Payment Serviceì—
- âœ… Cash Gateway ë‹¨ìˆœí™”: ë°©í™”ë²½ ì—­í• ë§Œ
- âœ… ì´ˆê¸° ê¸°íš ì˜ë„: "Payment Service = í•µì‹¬"
- âœ… í™•ì¥ì„±: Payment ë¡œì§ ë³µì¡í•´ì ¸ë„ Payment Serviceì—ì„œë§Œ ì²˜ë¦¬

**ë‹¨ì :**
- âš ï¸ ì›ìì„± A ê¹¨ì§ (PaymentProcessì™€ Payment ë‹¤ë¥¸ ì„œë¹„ìŠ¤)
  - í•˜ì§€ë§Œ Eventually Consistentë¡œ í•´ê²° ê°€ëŠ¥
  - PaymentProcessëŠ” ìƒíƒœ ì¶”ì ìš©ì´ë¼ ëœ ì¤‘ìš”
- âš ï¸ Cash Gateway README ìˆ˜ì • í•„ìš”
  - "Source of Truth" â†’ "PaymentProcessì˜ Source of Truth"

**ì§„ì‹¤ì˜ ì›ì²œ:**
- Cash Gateway: PaymentProcess (PG ìƒíƒœ ì¶”ì )
- Payment Service: Payment + Stock (ì£¼ë¬¸ ì´í–‰ ë°ì´í„°)

---

## ì›ìì„± ì¤‘ìš”ë„ ë¹„êµ

| ì›ìì„± | ì—”í‹°í‹° | ì¤‘ìš”ë„ | ì´ìœ  |
|--------|--------|--------|------|
| **ì›ìì„± A** | PaymentProcess + Payment | ë‚®ìŒ âš ï¸ | PaymentProcessëŠ” ë©”íƒ€ë°ì´í„°. Eventually Consistent ê°€ëŠ¥ |
| **ì›ìì„± B** | Payment + Stock + OrderSnapshot | ë†’ìŒ â­â­â­ | ì£¼ë¬¸ ì´í–‰ í•µì‹¬ ë°ì´í„°. ì •ì‚°/ë³µì› ë¶ˆê°€í•˜ë©´ ì¹˜ëª…ì  |

**ê²°ë¡ :** ì›ìì„± Bê°€ í›¨ì”¬ ë” ì¤‘ìš”í•˜ë‹¤!

---

## ë°ì´í„° ëª¨ë¸ ë¹„êµ

### ì˜µì…˜ A (í˜„ì¬)
```
cash_gateway_db:
  - payment_processes
  - payments â† ì—¬ê¸°!

payment_db:
  - products
  - product_records
  - product_order_snapshots
  - product_order_snapshot_items
```

### ì˜µì…˜ B (ì œì•ˆ)
```
cash_gateway_db:
  - payment_processes

payment_db:
  - products
  - product_records
  - product_order_snapshots
  - product_order_snapshot_items
  - payments â† ì´ë™!
```

---

## ê²°ë¡  ë° ì¶”ì²œ

### ì¶”ì²œ: ì˜µì…˜ B (Paymentë¥¼ Payment Serviceë¡œ ì´ë™) â­

### ê·¼ê±°

#### 1. ì›ìì„± ìš°ì„ ìˆœìœ„
```
ì¤‘ìš”: Payment + Stock + OrderSnapshot (ê°™ì€ íŠ¸ëœì­ì…˜) â­â­â­
ëœ ì¤‘ìš”: PaymentProcess + Payment (Eventually Consistent ê°€ëŠ¥) âš ï¸
```

#### 2. ì´ˆê¸° ê¸°íš ì˜ë„
> "í•µì‹¬ì€ ì‚¬ì‹¤ í˜ì´ë¨¼íŠ¸ ì‹œìŠ¤í…œì´ ì œì¼í•µì‹¬ì´ì•¼"

â†’ Payment Serviceê°€ í•µì‹¬ì´ë©´ Paymentë„ ì—¬ê¸° ìˆì–´ì•¼ í•¨

#### 3. ë„ë©”ì¸ ì‘ì§‘ì„±
```
Payment Serviceì— ì£¼ë¬¸ ì´í–‰ ë°ì´í„° ëª¨ë‘ ì§‘ì¤‘:
- Stock (ì¬ê³ )
- Payment (ê²°ì œ)
- OrderSnapshot (ì£¼ë¬¸ ìŠ¤ëƒ…ìƒ·)
- ProductRecord (ì¬ê³  ì´ë ¥)

â†’ "ì£¼ë¬¸ ì´í–‰"ì— í•„ìš”í•œ ëª¨ë“  ê²ƒì´ í•œ ê³³ì— âœ…
```

#### 4. Cash Gateway = ìˆœìˆ˜ ë°©í™”ë²½
```
Cash Gateway ì±…ì„ (ë‹¨ìˆœí™”):
- PG í†µì‹ 
- ì›¹í›… ìˆ˜ì‹ 
- ì´ë²¤íŠ¸ ë°œí–‰
- PaymentProcess (ìƒíƒœ ì¶”ì )

â†’ Payment ìƒì„±ì€ ì±…ì„ ì•„ë‹˜!
```

#### 5. í™•ì¥ì„±
- Payment ë¡œì§ì´ ë³µì¡í•´ì ¸ë„ Payment Serviceì—ì„œë§Œ ì²˜ë¦¬
- Cash GatewayëŠ” ë‹¨ìˆœí•œ ë°©í™”ë²½ ì—­í•  ìœ ì§€

---

## ìµœì¢… ì•„í‚¤í…ì²˜ (ì˜µì…˜ B)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cash Gateway (ê²°ì œ ë°©í™”ë²½)                     â”‚
â”‚                                               â”‚
â”‚  ì—­í• :                                         â”‚
â”‚  - PG í†µì‹  (HTTP)                             â”‚
â”‚  - ì›¹í›… ìˆ˜ì‹                                    â”‚
â”‚  - PaymentProcess ìƒíƒœ ê´€ë¦¬                    â”‚
â”‚  - Kafka ì´ë²¤íŠ¸ ë°œí–‰                           â”‚
â”‚                                               â”‚
â”‚  ì›¹í›… ìˆ˜ì‹  ì‹œ:                                 â”‚
â”‚  1. PaymentProcess â†’ SUCCESS                  â”‚
â”‚  2. PaymentApprovedEvent ë°œí–‰ (Kafka)         â”‚
â”‚  3. Payment ìƒì„± ì•ˆ í•¨! â­                     â”‚
â”‚                                               â”‚
â”‚  ì§„ì‹¤ì˜ ì›ì²œ: PaymentProcess (PG ìƒíƒœ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“ Kafka: PaymentApprovedEvent
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Payment Service (ì£¼ë¬¸ ì´í–‰ í•µì‹¬)               â”‚
â”‚                                               â”‚
â”‚  ì—­í• :                                         â”‚
â”‚  - ì¬ê³  ê´€ë¦¬ (ì„ ì°¨ê°)                          â”‚
â”‚  - Payment ìƒì„± â­                             â”‚
â”‚  - ì •ì‚° ê³„ì‚°                                   â”‚
â”‚  - ì´ë²¤íŠ¸ ì†Œì‹± (ProductRecord)                 â”‚
â”‚                                               â”‚
â”‚  PaymentApprovedEvent ìˆ˜ì‹  ì‹œ:                â”‚
â”‚  @Transactional {                             â”‚
â”‚    1. Payment ìƒì„± â­                          â”‚
â”‚    2. OrderSnapshot ì—°ê²° (ì´ë¯¸ ì¡´ì¬)           â”‚
â”‚    3. ProductRecord í™•ì¸ (ì´ë¯¸ ì¡´ì¬)           â”‚
â”‚  }                                            â”‚
â”‚                                               â”‚
â”‚  ì§„ì‹¤ì˜ ì›ì²œ: Payment + Stock â­                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Trade-off ë¶„ì„

### ì–»ëŠ” ê²ƒ âœ…
1. **ì›ìì„± B ë³´ì¥**: Payment + Stock + OrderSnapshot ê°™ì€ íŠ¸ëœì­ì…˜
2. **ë„ë©”ì¸ ì‘ì§‘ì„±**: ì£¼ë¬¸ ì´í–‰ ë°ì´í„° ëª¨ë‘ í•œ ê³³ì—
3. **Cash Gateway ë‹¨ìˆœí™”**: ë°©í™”ë²½ ì—­í• ë§Œ (ë” ëª…í™•í•¨)
4. **ì´ˆê¸° ê¸°íš ì˜ë„ ì¶©ì¡±**: Payment Service = í•µì‹¬
5. **í™•ì¥ì„±**: Payment ë¡œì§ ë³€ê²½ ì‹œ Payment Serviceë§Œ ìˆ˜ì •

### ìƒëŠ” ê²ƒ âš ï¸
1. **ì›ìì„± A ìƒì‹¤**: PaymentProcessì™€ Payment ë‹¤ë¥¸ ì„œë¹„ìŠ¤
   - í•˜ì§€ë§Œ: Eventually Consistentë¡œ ì¶©ë¶„
   - PaymentProcessëŠ” ìƒíƒœ ì¶”ì ìš©ì´ë¼ ëœ ì¤‘ìš”

2. **README ìˆ˜ì • í•„ìš”**: Cash Gatewayì˜ "Source of Truth" í‘œí˜„ ë³€ê²½
   - "Paymentì˜ Source of Truth" â†’ "PaymentProcessì˜ Source of Truth"

---

## êµ¬í˜„ ì‹œ ê³ ë ¤ì‚¬í•­

### 1. Payment ì—”í‹°í‹° ì´ë™
```kotlin
// payment-serviceì— ì¶”ê°€
@Entity
@Table(name = "payments")
class Payment(
    @Column(name = "process_public_id", length = 20)
    var processPublicId: String,  // Cash Gatewayì˜ PaymentProcess publicId

    @Column(name = "order_id")
    var orderId: Long,

    var amount: BigDecimal,

    @Enumerated(EnumType.STRING)
    var status: PaymentStatus,  // APPROVED, CANCELLED

    var pgTransaction: String?
) : AbsDomain()
```

### 2. Consumer ì¶”ê°€
```kotlin
// payment-service/consumer/CashGatewayEventConsumer.kt
@Transactional(propagation = Propagation.MANDATORY)
fun handlePaymentApproved(event: PaymentApprovedEvent) {
    // Payment ìƒì„±
    val payment = Payment(
        processPublicId = event.processPublicId,
        orderId = event.orderId,
        amount = event.amount,
        status = PaymentStatus.APPROVED,
        pgTransaction = event.pgTransaction
    )
    paymentRepository.save(payment)

    // OrderSnapshotëŠ” ì´ë¯¸ ì¡´ì¬ (ì„ ì°¨ê° ë•Œ ìƒì„±)
    // ProductRecordëŠ” ì´ë¯¸ ì¡´ì¬ (ì„ ì°¨ê° ë•Œ ìƒì„±)
}
```

### 3. Cash Gateway ìˆ˜ì •
```kotlin
// cash-gateway-serviceì—ì„œ Payment ìƒì„± ì œê±°
fun handleWebhook(payload: String) {
    // 1. PaymentProcessë§Œ ì—…ë°ì´íŠ¸
    process.status = SUCCESS
    paymentProcessRepository.save(process)

    // 2. Kafka ì´ë²¤íŠ¸ ë°œí–‰ (Payment ìƒì„± ì•ˆ í•¨!)
    publish(PaymentApprovedEvent(
        processPublicId = process.publicId,
        orderId = process.orderId,
        amount = process.amount,
        pgTransaction = process.pgTransaction
    ))
}
```

---

## ì§ˆë¬¸ ë¦¬ìŠ¤íŠ¸ (ë‹¤ë¥¸ AIì—ê²Œ)

1. **ì›ìì„± ìš°ì„ ìˆœìœ„ í‰ê°€ê°€ ë§ëŠ”ê°€?**
   - ì›ìì„± A (PaymentProcess + Payment) vs ì›ìì„± B (Payment + Stock)
   - ì–´ëŠ ê²ƒì´ ë” ì¤‘ìš”í•œê°€?

2. **ë„ë©”ì¸ ì‘ì§‘ì„± ê´€ì ì—ì„œ Payment ìœ„ì¹˜ëŠ”?**
   - Cash Gatewayì— ë‘¬ì•¼ í•˜ëŠ”ê°€?
   - Payment Serviceì— ë‘¬ì•¼ í•˜ëŠ”ê°€?

3. **Eventually Consistent ìˆ˜ìš© ê°€ëŠ¥ì„±?**
   - PaymentProcessì™€ Paymentê°€ ë‹¤ë¥¸ ì„œë¹„ìŠ¤ì— ìˆì–´ë„ ë˜ëŠ”ê°€?
   - ì–´ë–¤ ë³´ìƒ ë¡œì§ì´ í•„ìš”í•œê°€?

4. **ì§„ì‹¤ì˜ ì›ì²œ(Source of Truth)ì˜ ì •ì˜?**
   - Cash Gateway = "PaymentProcessì˜ Source of Truth"ë¡œ ì¶©ë¶„í•œê°€?
   - Payment Service = "Payment + Stockì˜ Source of Truth"ê°€ ë§ëŠ”ê°€?

5. **ì´ˆê¸° ê¸°íš ì˜ë„ì™€ì˜ ì •í•©ì„±?**
   - "Payment Service = í•µì‹¬"ì´ë©´ Paymentë„ ì—¬ê¸° ìˆì–´ì•¼ í•˜ëŠ”ê°€?
   - Cash Gateway = ë°©í™”ë²½ ì—­í• ë§Œìœ¼ë¡œ ì¶©ë¶„í•œê°€?

---

## ì°¸ê³  ë¬¸ì„œ

- [ë©”ì¸ README](./README.md)
- [Cash Gateway README](./cash-gateway-service/README.md)
- [Payment Service README](./payment-service/README.md)
- [ì´ˆê¸° ê¸°íš ë…¸íŠ¸](ì´ ë¬¸ì„œì— í¬í•¨ë¨)

---

**ì‘ì„±ì ì˜ê²¬:**
ì˜µì…˜ B (Paymentë¥¼ Payment Serviceë¡œ)ë¥¼ ê°•ë ¥íˆ ì¶”ì²œí•©ë‹ˆë‹¤.
ì›ìì„± B (Payment + Stock)ê°€ ì›ìì„± A (PaymentProcess + Payment)ë³´ë‹¤ í›¨ì”¬ ì¤‘ìš”í•˜ê¸° ë•Œë¬¸ì…ë‹ˆë‹¤.
