# Hamster PG Service

> **ğŸŒ EXTERNAL - ì™¸ë¶€ PG ì‹œë®¬ë ˆì´í„° (Hamster World ì†Œìœ  ì•„ë‹˜)**
> ë©”ì¸ README ì½ì€ í›„ ì´ ë¬¸ì„œë¥¼ ì½ìœ¼ì„¸ìš”.

**ì™¸ë¶€ PG(Payment Gateway) ì‹œë®¬ë ˆì´í„°**

---

## ì¤‘ìš”: ì´ ì„œë¹„ìŠ¤ëŠ” Hamster Worldì˜ ì¼ë¶€ê°€ ì•„ë‹™ë‹ˆë‹¤

### ì‹¤ì œ ì„œë¹„ìŠ¤ í™˜ê²½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Hamster World (ê²°ì œ ì¤‘ê°œ í”Œë«í¼)           â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  â”œâ”€ Ecommerce Service (ë²¤ë”ìš© SaaS)       â”‚
â”‚  â”œâ”€ Cash Gateway Service (ê²°ì œ ë°©í™”ë²½)    â”‚
â”‚  â””â”€ Payment Service (ì •ì‚°/ì¬ê³ )           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“ PG í†µì‹ 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì™¸ë¶€ PGì‚¬ (Hamster ì†Œìœ  ì•„ë‹˜)              â”‚
â”‚  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚
â”‚  - í† ìŠ¤í˜ì´ë¨¼ì¸  (https://tosspayments.com) â”‚
â”‚  - ì´ë‹ˆì‹œìŠ¤ (https://www.inicis.com)      â”‚
â”‚  - NHN KCP (https://www.kcp.co.kr)        â”‚
â”‚  - ...                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì´ í”„ë¡œì íŠ¸ì—ì„œì˜ ì—­í• 

**í•™ìŠµ/í…ŒìŠ¤íŠ¸ ëª©ì ìœ¼ë¡œë§Œ í¬í•¨:**
- âœ… ì‹¤ì œ PGì‚¬ APIë¥¼ ì‹œë®¬ë ˆì´ì…˜
- âœ… ì™¸ë¶€ PGë¡œë¶€í„° Webhookì„ ë°›ëŠ” ìƒí™© ì¬í˜„
- âœ… ë¹„ë™ê¸° ê²°ì œ ì²˜ë¦¬ í”Œë¡œìš° í…ŒìŠ¤íŠ¸
- âŒ ì‹¤ì œ ìš´ì˜ í™˜ê²½ì—ì„  **ì œê±°ë¨**
- âŒ Hamster World ì†Œìœ /ê´€ë¦¬ ì„œë¹„ìŠ¤ **ì•„ë‹˜**

---

## ê°œìš”

ì‹¤ì œ PGì‚¬(í† ìŠ¤í˜ì´ë¨¼ì¸ , ì´ë‹ˆì‹œìŠ¤ ë“±)ë¥¼ ì‹œë®¬ë ˆì´ì…˜í•˜ëŠ” ë”ë¯¸ ì„œë¹„ìŠ¤ì…ë‹ˆë‹¤.
ê°€ë§¹ì (cash-gateway)ì˜ ê²°ì œ ìš”ì²­ì„ ë°›ì•„ ë¹„ë™ê¸°ë¡œ ì²˜ë¦¬í•˜ê³  Webhookìœ¼ë¡œ ê²°ê³¼ë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.

**í•µì‹¬ íŠ¹ì§•:**
- âœ… HMAC-SHA256 ì„œëª… ê¸°ë°˜ ì¸ì¦ (ì‹¤ì œ PGì‚¬ì™€ ë™ì¼)
- âœ… ë¹„ë™ê¸° ì²˜ë¦¬ (202 Accepted ì¦‰ì‹œ ì‘ë‹µ)
- âœ… Scheduler ê¸°ë°˜ ê²°ì œ ìŠ¹ì¸ (1ì´ˆ í´ë§ - ì‹¤ì œëŠ” ìˆ˜ ì´ˆ~ìˆ˜ ë¶„)
- âœ… Fire-and-Forget Webhook (ì¬ì‹œë„ ì—†ìŒ)
- âœ… ë„ë©”ì¸ ì£¼ë„ ì„¤ê³„ (Payment, PgMid)
- âœ… ì„±ê³µ/ì‹¤íŒ¨ ëœë¤ ì‹œë®¬ë ˆì´ì…˜ (ì„±ê³µ 80%, ì‹¤íŒ¨ 20%)

---

## ë„ë©”ì¸ êµ¬ì¡°

### 1. **Payment** (ê²°ì œ ì²˜ë¦¬)

```kotlin
data class Payment(
    val tid: String,              // íŠ¸ëœì­ì…˜ ID
    val midId: String,            // ê°€ë§¹ì  ID
    val orderId: String,          // ì£¼ë¬¸ ID
    val amount: BigDecimal,       // ê²°ì œ ê¸ˆì•¡
    val status: PaymentStatus,    // ê²°ì œ ìƒíƒœ
    val approvalNo: String?,      // ìŠ¹ì¸ ë²ˆí˜¸
    val failureReason: String?    // ì‹¤íŒ¨ ì‚¬ìœ 
)
```

**ìƒíƒœ ì „ì´:**
```
PENDING â†’ COMPLETED (80% í™•ë¥ )
        â†’ FAILED (20% í™•ë¥ )

PENDING/COMPLETED â†’ CANCEL_PENDING â†’ CANCELLED
```

### 2. **PgMid** (ê°€ë§¹ì  ê´€ë¦¬)

```kotlin
data class PgMid(
    val midId: String,        // ê°€ë§¹ì  ID
    val merchantName: String, // ê°€ë§¹ì ëª…
    val apiKey: String,       // API Key (HMAC ì„œëª…ìš©)
    val isActive: Boolean     // í™œì„±í™” ì—¬ë¶€
)
```

**ì—­í• :**
- API Key ë°œê¸‰ ë° ê´€ë¦¬
- HMAC-SHA256 ì„œëª… ê²€ì¦
- ê°€ë§¹ì  í™œì„±í™”/ë¹„í™œì„±í™”

---

## API ëª…ì„¸

### Payment API

#### 1. ê²°ì œ ìƒì„±
```http
POST /api/payment
Content-Type: application/json

{
  "type": "PAYMENT",
  "midId": "MID_xxx",
  "timestamp": "20260128120000",
  "signature": "Base64(HMAC-SHA256(apiKey, message))",
  "orderId": "ORDER_12345",
  "amount": 10000.00,
  "callbackUrl": "https://merchant.com/webhook",
  "echo": "{\"userId\":\"user123\"}"
}

â†’ 202 Accepted
{
  "tid": "TID_20260128120000_abcd1234",
  "orderId": "ORDER_12345",
  "amount": 10000.00,
  "status": "PENDING"
}
```

**Signature ìƒì„± ë°©ë²•:**
```kotlin
val message = "$midId$timestamp$body"  // bodyëŠ” signature í•„ë“œ ì œì™¸
val signature = Base64.encode(
    HMAC-SHA256(apiKey, message)
)
```

#### 2. ê²°ì œ ì·¨ì†Œ
```http
POST /api/payment
Content-Type: application/json

{
  "type": "CANCEL",
  "midId": "MID_xxx",
  "timestamp": "20260128120100",
  "signature": "...",
  "tid": "TID_20260128120000_abcd1234"
}

â†’ 202 Accepted
{
  "tid": "TID_20260128120000_abcd1234",
  "orderId": "ORDER_12345",
  "amount": 10000.00,
  "status": "CANCEL_PENDING"
}
```

#### 3. ê²°ì œ ë‚´ì—­ ì¡°íšŒ (ë¦¬ìŠ¤íŠ¸)
```http
GET /api/payment/list?midId=MID_xxx&status=COMPLETED&from=2026-01-01&to=2026-01-31

â†’ 200 OK
[
  {
    "tid": "TID_xxx",
    "midId": "MID_xxx",
    "orderId": "ORDER_12345",
    "amount": 10000.00,
    "status": "COMPLETED",
    "approvalNo": "APV_xxx",
    "processedAt": "2026-01-28T12:00:01",
    ...
  }
]
```

**ê²€ìƒ‰ í•„í„°:**
- `midId`: ê°€ë§¹ì  ID
- `tid`: íŠ¸ëœì­ì…˜ ID (ë¶€ë¶„ ê²€ìƒ‰)
- `orderId`: ì£¼ë¬¸ ID (ë¶€ë¶„ ê²€ìƒ‰)
- `status`: ê²°ì œ ìƒíƒœ (PENDING, COMPLETED, FAILED, CANCEL_PENDING, CANCELLED)
- `notificationStatus`: ì•Œë¦¼ ìƒíƒœ (NOT_SENT, SENT)
- `from/to`: ë‚ ì§œ ë²”ìœ„
- `sort`: ì •ë ¬ (ASC, DESC)

#### 4. ê²°ì œ ë‚´ì—­ ì¡°íšŒ (í˜ì´ì§•)
```http
GET /api/payment/page?midId=MID_xxx&page=0&size=20&sort=DESC

â†’ 200 OK
{
  "content": [ ... ],
  "totalElements": 45,
  "totalPages": 3,
  "number": 0,
  "size": 20
}
```

#### 5. ê²°ì œ ë‹¨ê±´ ì¡°íšŒ
```http
GET /api/payment/TID_20260128120000_abcd1234

â†’ 200 OK
{
  "tid": "TID_20260128120000_abcd1234",
  "midId": "MID_xxx",
  "orderId": "ORDER_12345",
  "amount": 10000.00,
  "status": "COMPLETED",
  "approvalNo": "APV_20260128120001_789456",
  ...
}
```

---

### PgMid API

#### 1. ê°€ë§¹ì  ìƒì„±
```http
POST /api/mid
Content-Type: application/json

{
  "merchantName": "Hamster Corp"
}

â†’ 201 Created
{
  "midId": "MID_d7f9e4b2-...",
  "merchantName": "Hamster Corp",
  "apiKey": "e5c3a8f1-...",
  "isActive": true,
  "createdAt": "2026-01-28T12:00:00"
}
```

#### 2. ê°€ë§¹ì  ì¡°íšŒ
```http
GET /api/mid/MID_xxx

â†’ 200 OK
{
  "midId": "MID_xxx",
  "merchantName": "Hamster Corp",
  "apiKey": "e5c3a8f1-...",
  "isActive": true,
  ...
}
```

#### 3. ê°€ë§¹ì  ëª©ë¡ ì¡°íšŒ
```http
GET /api/mid/list?merchantName=Hamster&isActive=true

â†’ 200 OK
[ ... ]
```

#### 4. ê°€ë§¹ì  í˜ì´ì§• ì¡°íšŒ
```http
GET /api/mid/page?page=0&size=10

â†’ 200 OK
{
  "content": [ ... ],
  "totalElements": 25,
  ...
}
```

#### 5. ê°€ë§¹ì  í™œì„±í™”/ë¹„í™œì„±í™”
```http
POST /api/mid/MID_xxx/activate
POST /api/mid/MID_xxx/deactivate

â†’ 200 OK
{
  "midId": "MID_xxx",
  "isActive": true,  // or false
  ...
}
```

---

## ë¹„ë™ê¸° ì²˜ë¦¬ í”Œë¡œìš°

### 1. ê²°ì œ ìƒì„± í”Œë¡œìš°
```
[1] Client â†’ POST /api/payment (PAYMENT)
              â†“
[2] @ValidSignature ê²€ì¦ (HMAC-SHA256)
              â†“
[3] PaymentService.createPayment()
     - Payment.create() â†’ PENDING
     - repository.save()
              â†“
[4] 202 Accepted ì¦‰ì‹œ ì‘ë‹µ
              â†“
[5] PaymentScheduler (1ì´ˆë§ˆë‹¤ í´ë§)
     - findPendingPayments(threshold = now - 1ì´ˆ)
     - processPayment() â†’ COMPLETED (80%) or FAILED (20%)
     - repository.save()
              â†“
[6] NotificationService.sendWebhookAsync()
     - WebClient.post(callbackUrl)
     - Timeout: 5ì´ˆ
     - Fire-and-Forget (ì¬ì‹œë„ ì—†ìŒ)
```

### 2. ê²°ì œ ì·¨ì†Œ í”Œë¡œìš°
```
[1] Client â†’ POST /api/payment (CANCEL)
              â†“
[2] @ValidSignature ê²€ì¦
              â†“
[3] PaymentService.requestCancelPayment()
     - payment.requestCancel() â†’ CANCEL_PENDING
     - repository.save()
              â†“
[4] 202 Accepted ì¦‰ì‹œ ì‘ë‹µ
              â†“
[5] PaymentScheduler (1ì´ˆë§ˆë‹¤ í´ë§)
     - findCancelPendingPayments(threshold = now - 1ì´ˆ)
     - payment.cancel() â†’ CANCELLED
     - repository.save()
              â†“
[6] NotificationService.sendWebhookAsync()
```

---

## ì¸ì¦ ë©”ì»¤ë‹ˆì¦˜

### HMAC-SHA256 Signature

**ìš”ì²­ ì‹œ í¬í•¨:**
```json
{
  "midId": "MID_xxx",
  "timestamp": "20260128120000",
  "signature": "Base64(HMAC-SHA256)",
  ...
}
```

**ê²€ì¦ ê³¼ì •:**
1. **Timestamp ê²€ì¦** (5ë¶„ ì´ë‚´ ìš”ì²­ë§Œ í—ˆìš©)
2. **PgMid ì¡°íšŒ** (midIdë¡œ apiKey íšë“)
3. **Body ì¬êµ¬ì„±** (signature í•„ë“œë¥¼ ë¹ˆ ë¬¸ìì—´ë¡œ)
4. **Message ìƒì„±:** `"$midId$timestamp$body"`
5. **Signature ìƒì„±:** `Base64(HMAC-SHA256(apiKey, message))`
6. **ë¹„êµ:** ìš”ì²­ì˜ signatureì™€ ìƒì„±í•œ signature ì¼ì¹˜ ì—¬ë¶€

**êµ¬í˜„ ìœ„ì¹˜:**
- `@ValidSignature` - Bean Validation Constraint
- `SignatureConstraintValidator` - ì‹¤ì œ ê²€ì¦ ë¡œì§
- Jackson ì—­ì§ë ¬í™” í›„ ì‹¤í–‰ (Body ì¬êµ¬ì„± ê°€ëŠ¥)

### Request Scope ê³µìœ 

```kotlin
// SignatureConstraintValidator
private fun storeInRequestScope(pgMid: PgMid) {
    val request = (RequestContextHolder.getRequestAttributes()
        as ServletRequestAttributes).request
    request.setAttribute("pgMid", pgMid)
}

// MidArgumentResolver
override fun resolveArgument(...): Any? {
    return webRequest.getAttribute("pgMid", SCOPE_REQUEST)
}

// PaymentController
fun processPayment(
    @Valid @RequestBody request: PaymentRequest,
    @CurrentMid pgMid: PgMid  // â† ìë™ ì£¼ì…
)
```

---

## ì£¼ìš” ì»´í¬ë„ŒíŠ¸

### Domain Layer

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  |
|---------|------|
| **Payment** | ê²°ì œ ë„ë©”ì¸ ëª¨ë¸ |
| **PgMid** | ê°€ë§¹ì  ë„ë©”ì¸ ëª¨ë¸ |
| **PaymentStatus** | ê²°ì œ ìƒíƒœ Enum |
| **PaymentService** | ê²°ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ |
| **PgMidService** | ê°€ë§¹ì  ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ |
| **PaymentScheduler** | 1ì´ˆë§ˆë‹¤ PENDING ì²˜ë¦¬ |
| **PaymentSchedulerService** | Scheduler ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ |
| **NotificationService** | Webhook ì „ì†¡ (@Async) |

### Event Layer

| ì´ë²¤íŠ¸ | ë°œìƒ ì‹œì  |
|--------|---------|
| **PaymentCompletedEvent** | ê²°ì œ ì™„ë£Œ ì‹œ |
| **PaymentFailedEvent** | ê²°ì œ ì‹¤íŒ¨ ì‹œ |
| **CancelRequestedEvent** | ì·¨ì†Œ ìš”ì²­ ì‹œ |
| **PaymentCancelledEvent** | ì·¨ì†Œ ì™„ë£Œ ì‹œ |
| **NotificationSentEvent** | Webhook ì „ì†¡ ì‹œ |

**ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬:**
- `PaymentEventHandler` - `@TransactionalEventListener(AFTER_COMMIT)`
- í˜„ì¬ëŠ” ë¡œê¹…ë§Œ (Schedulerê°€ Webhook ì „ì†¡)

### Infrastructure Layer

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  |
|---------|------|
| **PaymentEntity** | JPA Entity (@Table("payments")) |
| **PaymentRepository** | ë„ë©”ì¸ Repository |
| **PaymentJpaRepository** | Spring Data JPA |
| **PaymentMapper** | Entity â†” Domain ë³€í™˜ |
| **PgMidEntity** | JPA Entity (@Table("pg_mids")) |
| **PgMidRepository** | ë„ë©”ì¸ Repository |
| **PgMidMapper** | Entity â†” Domain ë³€í™˜ |

### Application Layer

| ì»´í¬ë„ŒíŠ¸ | ì—­í•  |
|---------|------|
| **PaymentController** | REST API ì—”ë“œí¬ì¸íŠ¸ |
| **PgMidController** | ê°€ë§¹ì  REST API |
| **@ValidSignature** | ì„œëª… ê²€ì¦ ì–´ë…¸í…Œì´ì…˜ |
| **SignatureConstraintValidator** | Bean Validation êµ¬í˜„ |
| **@CurrentMid** | ArgumentResolver ì–´ë…¸í…Œì´ì…˜ |
| **MidArgumentResolver** | Request Scopeì—ì„œ PgMid ì£¼ì… |

---

## ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### payments í…Œì´ë¸”
```sql
CREATE TABLE `payments` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
    `tid` VARCHAR(50) NOT NULL COMMENT 'Payment íŠ¸ëœì­ì…˜ ê³ ìœ  ID',
    `mid_id` VARCHAR(100) NOT NULL COMMENT 'ê°€ë§¹ì  ID',
    `order_id` VARCHAR(255) NOT NULL COMMENT 'ì£¼ë¬¸ ID',
    `amount` DECIMAL(19, 2) NOT NULL COMMENT 'ê²°ì œ ê¸ˆì•¡',
    `callback_url` VARCHAR(500) NOT NULL COMMENT 'Webhook ì½œë°± URL',
    `echo` TEXT NULL COMMENT 'Echo ë°ì´í„° (JSON)',
    `status` VARCHAR(20) NOT NULL COMMENT 'ê²°ì œ ìƒíƒœ',
    `approval_no` VARCHAR(50) NULL COMMENT 'ìŠ¹ì¸ ë²ˆí˜¸',
    `notification_status` VARCHAR(20) NOT NULL,
    `notification_attempt_count` INT NOT NULL DEFAULT 0,
    `last_notification_at` DATETIME NULL,
    `notification_error_message` TEXT NULL,
    `failure_reason` VARCHAR(100) NULL,
    `processed_at` DATETIME NULL,
    `created_at` DATETIME NOT NULL,
    `modified_at` DATETIME NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_payments_tid` (`tid`),
    KEY `idx_payments_status_created_at` (`status`, `created_at`),
    KEY `idx_payments_mid_id` (`mid_id`)
);
```

### pg_mids í…Œì´ë¸”
```sql
CREATE TABLE `pg_mids` (
    `id` BIGINT(20) NOT NULL AUTO_INCREMENT,
    `mid_id` VARCHAR(100) NOT NULL COMMENT 'ê°€ë§¹ì  ID',
    `merchant_name` VARCHAR(255) NOT NULL COMMENT 'ê°€ë§¹ì ëª…',
    `api_key` VARCHAR(255) NOT NULL COMMENT 'API Key',
    `is_active` TINYINT(1) NOT NULL DEFAULT 1,
    `created_at` DATETIME NOT NULL,
    `modified_at` DATETIME NULL,
    PRIMARY KEY (`id`),
    UNIQUE KEY `uk_pg_mids_mid_id` (`mid_id`),
    UNIQUE KEY `uk_pg_mids_api_key` (`api_key`)
);
```

---

## ì„¤ì •

### application.yml (ì£¼ìš” ì„¤ì •)
```yaml
server:
  port: 8083

spring:
  datasource:
    url: jdbc:mysql://localhost:3309/hamster_pg_db
    username: root
    password: 12555!@

  jpa:
    hibernate:
      ddl-auto: none
    properties:
      hibernate:
        format_sql: true

  task:
    scheduling:
      pool:
        size: 5

    execution:
      pool:
        core-size: 10
        max-size: 20
```

### ìŠ¤ì¼€ì¤„ëŸ¬ ì„¤ì •
```kotlin
@EnableScheduling
@EnableAsync
class HamsterPgApplication

@Scheduled(fixedDelay = 1000)  // 1ì´ˆë§ˆë‹¤
fun processPending() {
    schedulerService.processPendingTransactions()
}
```

---

## íƒ€ì„ë¼ì¸ ì˜ˆì œ

```
T+0ms:    Client â†’ POST /api/payment (PAYMENT)
          â””â”€ Validation (HMAC-SHA256)
          â””â”€ Service (save PENDING)
          â””â”€ 202 Accepted ì‘ë‹µ

T+1000ms: Scheduler ì‹¤í–‰
          â””â”€ findPendingPayments(threshold = now - 1ì´ˆ)
          â””â”€ processPayment() â†’ COMPLETED (80%) or FAILED (20%)
          â””â”€ save()
          â””â”€ sendWebhookAsync() (ë¹„ë™ê¸°)

T+1100ms: Webhook ì „ì†¡ ì‹œì‘
          â””â”€ POST https://merchant.com/webhook
          â””â”€ { "tid": "...", "status": "COMPLETED", ... }
          â””â”€ markNotificationSent()

T+2000ms: Client â†’ POST /api/payment (CANCEL)
          â””â”€ Validation
          â””â”€ Service (save CANCEL_PENDING)
          â””â”€ 202 Accepted ì‘ë‹µ

T+3000ms: Scheduler ì‹¤í–‰
          â””â”€ findCancelPendingPayments(threshold = now - 1ì´ˆ)
          â””â”€ payment.cancel() â†’ CANCELLED
          â””â”€ save()
          â””â”€ sendWebhookAsync() (ë¹„ë™ê¸°)

T+3100ms: Webhook ì „ì†¡
          â””â”€ POST https://merchant.com/webhook
          â””â”€ { "tid": "...", "status": "CANCELLED", ... }
```

---

## ê°œì„  ê°€ëŠ¥í•œ ë¶€ë¶„

### í˜„ì¬ êµ¬í˜„ (Phase 1)
- âœ… ê¸°ë³¸ ê²°ì œ/ì·¨ì†Œ í”Œë¡œìš°
- âœ… HMAC-SHA256 ì¸ì¦
- âœ… ë¹„ë™ê¸° ì²˜ë¦¬ (Scheduler)
- âœ… Fire-and-Forget Webhook
- âœ… ëœë¤ ê²°ì œ ìŠ¹ì¸ (80% ì„±ê³µë¥ )

### Phase 2 (ê°œì„ )
- [ ] **Webhook ì¬ì‹œë„** - Exponential Backoff
- [ ] **ë¶„ì‚° ë½** - Redis ë˜ëŠ” ShedLock (ë‹¤ì¤‘ ì¸ìŠ¤í„´ìŠ¤ ëŒ€ë¹„)
- [ ] **Dead Letter Queue** - ì‹¤íŒ¨í•œ Webhook ì²˜ë¦¬
- [ ] **ê²°ì œ ìŠ¹ì¸ ë¡œì§** - ì‹¤ì œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (í˜„ì¬ëŠ” ëœë¤)

### Phase 3 (ê³ ë„í™”)
- [ ] **Event Sourcing** - ëª¨ë“  ìƒíƒœ ë³€ê²½ ì´ë²¤íŠ¸ ì €ì¥
- [ ] **CQRS** - ì¡°íšŒ/ëª…ë ¹ ë¶„ë¦¬
- [ ] **Saga Pattern** - ë¶„ì‚° íŠ¸ëœì­ì…˜ ê´€ë¦¬
- [ ] **Monitoring** - Prometheus/Grafana ì—°ë™

---

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì„±ê³µ ì¼€ì´ìŠ¤
```bash
# 1. ê°€ë§¹ì  ìƒì„±
curl -X POST http://localhost:8083/api/mid \
  -H "Content-Type: application/json" \
  -d '{"merchantName": "Test Merchant"}'

# Responseì—ì„œ midId, apiKey í™•ì¸

# 2. Signature ìƒì„± (Kotlin)
val message = "$midId$timestamp$body"
val signature = Base64.getEncoder().encodeToString(
    Mac.getInstance("HmacSHA256").apply {
        init(SecretKeySpec(apiKey.toByteArray(), "HmacSHA256"))
    }.doFinal(message.toByteArray())
)

# 3. ê²°ì œ ìƒì„±
curl -X POST http://localhost:8083/api/payment \
  -H "Content-Type: application/json" \
  -d '{
    "type": "PAYMENT",
    "midId": "MID_xxx",
    "timestamp": "20260128120000",
    "signature": "generated_signature",
    "orderId": "ORDER_001",
    "amount": 10000.00,
    "callbackUrl": "https://webhook.site/xxx"
  }'

# 4. 1ì´ˆ ëŒ€ê¸° í›„ ìƒíƒœ í™•ì¸
sleep 1
curl http://localhost:8083/api/payment/TID_xxx

# 5. ì·¨ì†Œ ìš”ì²­
curl -X POST http://localhost:8083/api/payment \
  -H "Content-Type: application/json" \
  -d '{
    "type": "CANCEL",
    "midId": "MID_xxx",
    "timestamp": "20260128120100",
    "signature": "generated_signature",
    "tid": "TID_xxx"
  }'
```

### ì‹¤íŒ¨ ì¼€ì´ìŠ¤
```bash
# Signature ë¶ˆì¼ì¹˜
â†’ 400 Bad Request

# ì´ë¯¸ ì·¨ì†Œëœ ê²°ì œ ì¬ì·¨ì†Œ
â†’ 400 Bad Request "Payment already cancelled"

# FAILED ìƒíƒœ ê²°ì œ ì·¨ì†Œ
â†’ 400 Bad Request "Payment cannot be cancelled"
```

---

## ë¡œê·¸ ì˜ˆì œ

```log
2026-01-28 12:00:00.000  INFO --- Payment request received: type=CreatePaymentRequest, midId=MID_xxx
2026-01-28 12:00:00.001  INFO --- Creating payment: orderId=ORDER_12345, amount=10000.00
2026-01-28 12:00:01.000  INFO --- Processing 1 pending payments
2026-01-28 12:00:01.050  INFO --- Payment completed event received: tid=TID_xxx, approvalNo=APV_xxx
2026-01-28 12:00:01.100  INFO --- Sending webhook asynchronously: ... to https://merchant.com/webhook
2026-01-28 12:00:01.500  INFO --- Webhook sent successfully: ...
2026-01-28 12:00:02.000  INFO --- Payment request received: type=CancelPaymentRequest
2026-01-28 12:00:02.001  INFO --- Requesting cancellation: tid=TID_xxx
2026-01-28 12:00:02.050  INFO --- Cancel requested event received: tid=TID_xxx
2026-01-28 12:00:03.000  INFO --- Processing 1 cancel pending payments
2026-01-28 12:00:03.050  INFO --- Payment cancelled event received: tid=TID_xxx
2026-01-28 12:00:03.100  INFO --- Sending webhook asynchronously: ...
2026-01-28 12:00:03.500  INFO --- Webhook sent successfully: ...
```

---

## ì°¸ê³ 

- **ì „ì²´ ì•„í‚¤í…ì²˜:** [../README.md](../README.md)
- **ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ:** `db/` ë””ë ‰í† ë¦¬
- **Gradle ë¹Œë“œ:** `./gradlew :hamster-pg-service:build`
